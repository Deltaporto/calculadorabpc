<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora Biopsicossocial — BPC/LOAS</title>
  <meta name="description" content="Calculadora interativa para avaliação biopsicossocial do BPC">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Source+Sans+3:wght@300;400;600;700&display=swap"
    rel="stylesheet">
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    :root {
      --bg: #F0F2F7;
      --surface: #FFF;
      --text: #0F1B2D;
      --text2: #4B5563;
      --text3: #6B7280;
      --border: #E5E7EB;
      --navy: #0F1B2D;
      --gold: #C5A55A;
      --blue: #2563EB;
      --qN: #9CA3AF;
      --qL: #60A5FA;
      --qM: #FBBF24;
      --qG: #FB923C;
      --qC: #EF4444;
      --yes: #059669;
      --no: #DC2626;
      --radius: 12px;
      --shadow: 0 1px 3px rgba(0, 0, 0, .08), 0 1px 2px rgba(0, 0, 0, .04);
      --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, .1);
    }

    [data-theme="dark"] {
      --bg: #0A0F1A;
      --surface: #141B2D;
      --text: #F1F5F9;
      --text2: #94A3B8;
      --text3: #94A3B8;
      --border: #1E293B;
      --shadow: 0 1px 3px rgba(0, 0, 0, .3);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, .4);
    }

    html {
      font-size: 15px
    }

    body {
      font-family: 'Source Sans 3', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh
    }

    h1,
    h2,
    h3 {
      font-family: 'DM Sans', sans-serif;
      font-weight: 700
    }

    .icon-sprite {
      position: absolute;
      width: 0;
      height: 0;
      overflow: hidden;
      pointer-events: none
    }

    .ui-icon {
      width: 1.05em;
      height: 1.05em;
      flex-shrink: 0;
      display: inline-block;
      vertical-align: -.12em;
      fill: none;
      stroke: currentColor;
      stroke-width: 1.9;
      stroke-linecap: round;
      stroke-linejoin: round
    }

    .ui-icon.sm {
      width: .95em;
      height: .95em
    }

    .ui-icon.lg {
      width: 2.1rem;
      height: 2.1rem
    }

    .app {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 16px 40px
    }

    /* HEADER */
    header {
      background: var(--navy);
      color: #fff;
      padding: 24px 32px;
      border-radius: 0 0 20px 20px;
      margin: 0 -16px 20px;
      text-align: center
    }

    header h1 {
      font-size: 1.8rem;
      letter-spacing: -.02em;
      margin-bottom: 4px
    }

    header .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--gold);
      color: var(--navy);
      font-size: .7rem;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 20px;
      margin-bottom: 8px;
      letter-spacing: .05em;
      text-transform: uppercase
    }

    header .badge .ui-icon {
      width: .86em;
      height: .86em
    }

    header p {
      color: rgba(255, 255, 255, .65);
      font-size: .85rem
    }

    .app-mode-switch {
      margin: 14px auto 0;
      display: inline-flex;
      align-items: center;
      border: 1.5px solid rgba(255, 255, 255, .22);
      border-radius: 10px;
      overflow: hidden;
      background: rgba(255, 255, 255, .06)
    }

    .mode-btn {
      min-width: 154px;
      border: none;
      background: transparent;
      color: rgba(255, 255, 255, .75);
      font-weight: 700;
      font-size: .8rem;
      padding: 8px 12px;
      cursor: pointer;
      transition: background .18s, color .18s
    }

    .mode-btn + .mode-btn {
      border-left: 1px solid rgba(255, 255, 255, .18)
    }

    .mode-btn.active {
      background: #fff;
      color: var(--navy)
    }

    .header-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-top: 12px;
      flex-wrap: wrap
    }

    .header-row label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: .8rem;
      color: rgba(255, 255, 255, .7);
      cursor: pointer;
      user-select: none
    }

    .header-row input[type=checkbox] {
      accent-color: var(--gold);
      width: 16px;
      height: 16px
    }

    /* TOOLBAR */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center
    }

    .btn {
      font-family: 'DM Sans', sans-serif;
      font-weight: 600;
      font-size: .85rem;
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      cursor: pointer;
      transition: all .2s;
      display: inline-flex;
      align-items: center;
      gap: 6px
    }

    .btn .ui-icon {
      width: .95em;
      height: .95em
    }

    .btn-gold {
      background: linear-gradient(135deg, #C5A55A, #D4B96A);
      color: #1a1a1a;
      box-shadow: 0 2px 8px rgba(197, 165, 90, .3)
    }

    .btn-gold:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(197, 165, 90, .4)
    }

    .btn-outline {
      background: var(--surface);
      color: var(--text);
      border: 1.5px solid var(--border)
    }

    .btn-outline:hover {
      border-color: var(--text3)
    }

    .btn-red {
      background: #FEE2E2;
      color: #991B1B;
      border: 1.5px solid #FECACA
    }

    .idade-input {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: .85rem;
      color: rgba(255, 255, 255, .82)
    }

    .idade-input input,
    .idade-input select {
      width: 60px;
      padding: 6px 8px;
      border: 1.5px solid var(--border);
      border-radius: 6px;
      font-size: .85rem;
      background: var(--surface);
      color: var(--text);
      text-align: center
    }

    .idade-input select {
      width: auto;
      text-align: left;
      cursor: pointer
    }

    .idade-status {
      font-size: .78rem;
      color: rgba(255, 255, 255, .64)
    }

    .hidden {
      display: none !important
    }

    .simulador-details {
      margin-bottom: 16px
    }

    .simulador-summary {
      list-style: none;
      cursor: pointer;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--surface);
      color: var(--text2);
      padding: 10px 12px;
      font-size: .8rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none
    }

    .simulador-summary::-webkit-details-marker {
      display: none
    }

    .simulador-summary::after {
      content: '+';
      font-size: .95rem;
      color: var(--text3)
    }

    .simulador-details[open] .simulador-summary::after {
      content: '−'
    }

    .simulador-body {
      margin-top: 10px
    }

    .mode-simulador .simulador-summary {
      display: none
    }

    .mode-simulador .simulador-body {
      margin-top: 0
    }

    .mode-simulador #judicialControlSection,
    .mode-simulador #compSection {
      display: none
    }

    .mode-controle .footer-actions,
    .mode-controle #textoSection {
      display: none
    }

    /* PANELS */
    .calculator {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 20px
    }

    @media(max-width:1024px) {
      .calculator {
        grid-template-columns: 1fr
      }

      .mode-btn {
        min-width: 132px
      }
    }

    .panel {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column
    }

    .panel-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, color-mix(in srgb, var(--panel-color) 6%, var(--surface)), var(--surface))
    }

    .panel-icon {
      width: 38px;
      height: 38px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--panel-color);
      background: color-mix(in srgb, var(--panel-color) 14%, transparent);
      border: 1px solid color-mix(in srgb, var(--panel-color) 28%, transparent)
    }

    .panel-icon .ui-icon {
      width: 1.35rem;
      height: 1.35rem
    }

    .panel-header h2 {
      font-size: 1rem;
      color: var(--text)
    }

    .panel-header .sub {
      font-size: .75rem;
      color: var(--text3);
      margin-top: 1px
    }

    .domains {
      padding: 12px 16px;
      flex: 1
    }

    /* DOMAIN ROW */
    .domain-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px solid color-mix(in srgb, var(--border) 50%, transparent)
    }

    .domain-row:last-child {
      border-bottom: none
    }

    .domain-label {
      flex: 1;
      min-width: 0
    }

    .domain-code {
      display: inline-block;
      font-family: 'DM Sans', sans-serif;
      font-weight: 700;
      font-size: .75rem;
      color: var(--text3);
      width: 22px
    }

    .domain-name {
      font-size: .8rem;
      color: var(--text2)
    }

    .note-buttons {
      display: flex;
      gap: 3px;
      flex-shrink: 0
    }

    .note-scale-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 0 4px
    }

    .note-scale-spacer {
      flex: 1;
      min-width: 0
    }

    .note-scale {
      display: grid;
      grid-template-columns: repeat(5, 34px);
      gap: 3px;
      flex-shrink: 0
    }

    .note-scale span {
      text-align: center;
      font-size: .66rem;
      color: var(--text3);
      font-weight: 700;
      letter-spacing: .02em
    }

    .note-btn {
      width: 34px;
      height: 34px;
      border-radius: 7px;
      border: 1.5px solid var(--border);
      background: var(--surface);
      font-family: 'DM Sans', sans-serif;
      font-weight: 600;
      font-size: .8rem;
      color: var(--text3);
      cursor: pointer;
      position: relative;
      overflow: hidden;
      isolation: isolate;
      --hover-color: var(--text3);
      --hover-fg: #fff;
      transition: transform .18s cubic-bezier(.2, .8, .2, 1), border-color .18s ease, box-shadow .18s ease, background .2s ease, color .2s ease, filter .2s ease
    }

    .note-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(120deg, transparent 20%, rgba(255, 255, 255, .45) 50%, transparent 80%);
      transform: translateX(-135%);
      opacity: 0;
      transition: transform .4s ease, opacity .2s ease;
      pointer-events: none
    }

    .note-btn[data-value="0"] {
      --hover-color: var(--qN);
      --hover-fg: #fff
    }

    .note-btn[data-value="1"] {
      --hover-color: var(--qL);
      --hover-fg: #fff
    }

    .note-btn[data-value="2"] {
      --hover-color: var(--qM);
      --hover-fg: #1a1a1a
    }

    .note-btn[data-value="3"] {
      --hover-color: var(--qG);
      --hover-fg: #fff
    }

    .note-btn[data-value="4"] {
      --hover-color: var(--qC);
      --hover-fg: #fff
    }

    @media (hover:hover) {
      .note-btn:hover {
        border-color: color-mix(in srgb, var(--hover-color) 48%, var(--border) 52%);
        background: linear-gradient(145deg, color-mix(in srgb, var(--hover-color) 14%, var(--surface)), color-mix(in srgb, var(--hover-color) 6%, var(--surface)));
        color: color-mix(in srgb, var(--hover-color) 54%, var(--text2) 46%);
        transform: translateY(-1px) scale(1.02);
        filter: saturate(1.05);
        box-shadow:
          0 0 0 2px color-mix(in srgb, var(--hover-color) 10%, transparent),
          0 4px 8px color-mix(in srgb, var(--hover-color) 18%, transparent)
      }

      .note-btn:hover::after {
        transform: translateX(110%);
        opacity: .45
      }

      .note-btn.active:hover {
        background: var(--hover-color);
        color: var(--hover-fg);
        border-color: var(--hover-color);
        box-shadow:
          0 0 0 2px color-mix(in srgb, var(--hover-color) 16%, transparent),
          0 5px 10px color-mix(in srgb, var(--hover-color) 22%, transparent),
          inset 0 1px 0 rgba(255, 255, 255, .22)
      }

      .note-btn:active {
        transform: translateY(0) scale(1)
      }
    }

    .note-btn.active[data-value="0"] {
      background: var(--qN);
      color: #fff;
      border-color: var(--qN)
    }

    .note-btn.active[data-value="1"] {
      background: var(--qL);
      color: #fff;
      border-color: var(--qL)
    }

    .note-btn.active[data-value="2"] {
      background: var(--qM);
      color: #1a1a1a;
      border-color: var(--qM)
    }

    .note-btn.active[data-value="3"] {
      background: var(--qG);
      color: #fff;
      border-color: var(--qG)
    }

    .note-btn.active[data-value="4"] {
      background: var(--qC);
      color: #fff;
      border-color: var(--qC)
    }

    .note-btn.locked {
      opacity: .7;
      cursor: not-allowed;
      pointer-events: none
    }

    .note-btn.locked.active {
      opacity: 1
    }

    .section-label {
      font-size: .7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .08em;
      padding: 8px 0 4px;
      display: flex;
      align-items: center;
      gap: 6px
    }

    .badge-m {
      background: #EFF6FF;
      color: #1D4ED8;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: .65rem
    }

    .badge-s {
      background: #F0FDF4;
      color: #166534;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: .65rem
    }

    /* PANEL RESULT */
    .panel-result {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: color-mix(in srgb, var(--bg) 50%, var(--surface))
    }

    .formula {
      font-size: .78rem;
      color: var(--text3);
      margin-bottom: 8px;
      font-variant-numeric: tabular-nums
    }

    .formula .val {
      font-weight: 700;
      color: var(--text)
    }

    .result-bar {
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px
    }

    .result-fill {
      height: 100%;
      border-radius: 4px;
      transition: width .4s ease, background .3s
    }

    .panel-result-row {
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    .qualifier-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 42px;
      height: 42px;
      border-radius: 10px;
      font-family: 'DM Sans', sans-serif;
      font-weight: 700;
      font-size: 1.2rem;
      color: #fff;
      transition: all .3s
    }

    .qualifier-badge[data-q="N"] {
      background: var(--qN)
    }

    .qualifier-badge[data-q="L"] {
      background: var(--qL)
    }

    .qualifier-badge[data-q="M"] {
      background: var(--qM);
      color: #1a1a1a
    }

    .qualifier-badge[data-q="G"] {
      background: var(--qG)
    }

    .qualifier-badge[data-q="C"] {
      background: var(--qC)
    }

    .qualifier-badge.large {
      width: 56px;
      height: 56px;
      font-size: 1.5rem;
      border-radius: 14px
    }

    .qual-name {
      font-size: .75rem;
      color: var(--text3);
      margin-top: 2px
    }

    .majoracao-toggles {
      padding: 8px 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      border-top: 1px solid var(--border)
    }

    .toggle-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: .8rem;
      color: var(--text2);
      cursor: pointer;
      user-select: none
    }

    .toggle-switch {
      position: relative;
      width: 36px;
      height: 20px;
      background: var(--border);
      border-radius: 10px;
      transition: .3s;
      flex-shrink: 0
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      background: #fff;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: .3s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .2)
    }

    input:checked+.toggle-switch {
      background: var(--blue)
    }

    input:checked+.toggle-switch::after {
      left: 18px
    }

    .toggle-label input[type=checkbox] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0
    }

    /* RESULTADO */
    .resultado {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      padding: 24px;
      margin-bottom: 20px
    }

    .resultado>h2 {
      text-align: center;
      font-size: 1.1rem;
      margin-bottom: 20px;
      color: var(--text2)
    }

    .qualifiers-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 24px
    }

    .qual-card {
      text-align: center;
      padding: 12px 20px;
      border-radius: 12px;
      background: var(--bg);
      min-width: 140px
    }

    .qual-label {
      display: block;
      font-size: .7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: var(--text3);
      margin-bottom: 8px
    }

    .qual-desc {
      display: block;
      font-size: .72rem;
      color: var(--text3);
      margin-top: 4px
    }

    .qual-sep {
      font-size: 1.5rem;
      color: var(--text3);
      font-weight: 300
    }

    /* TABELA CONCLUSIVA */
    .tabela-section {
      margin-bottom: 24px
    }

    .tabela-section h3 {
      font-size: .9rem;
      text-align: center;
      margin-bottom: 12px;
      color: var(--text2)
    }

    .amb-tabs {
      display: flex;
      justify-content: center;
      gap: 4px;
      margin-bottom: 12px
    }

    .amb-tab-label {
      font-size: .75rem;
      color: var(--text3);
      align-self: center;
      margin-right: 8px
    }

    .amb-tab {
      width: 36px;
      height: 30px;
      border-radius: 6px;
      border: 1.5px solid var(--border);
      background: var(--surface);
      font-family: 'DM Sans', sans-serif;
      font-weight: 600;
      font-size: .8rem;
      color: var(--text3);
      cursor: pointer;
      transition: all .15s
    }

    .amb-tab.active {
      background: var(--navy);
      color: #fff;
      border-color: var(--navy)
    }

    [data-theme="dark"] .amb-tab.active {
      background: var(--gold);
      color: #1a1a1a;
      border-color: var(--gold)
    }

    .tabela-grid {
      display: grid;
      grid-template-columns: auto repeat(5, 1fr);
      gap: 3px;
      max-width: 500px;
      margin: 0 auto
    }

    .tc {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 44px;
      border-radius: 6px;
      font-family: 'DM Sans', sans-serif;
      font-weight: 600;
      font-size: .75rem;
      transition: all .3s
    }

    .tc.header {
      background: transparent;
      color: var(--text3);
      font-size: .7rem
    }

    .tc.corner {
      background: transparent
    }

    .tc.row-header {
      background: transparent;
      color: var(--text3);
      font-size: .7rem;
      justify-content: flex-end;
      padding-right: 8px
    }

    .tc.yes {
      background: #D1FAE5;
      color: #065F46
    }

    .tc.no {
      background: #FEE2E2;
      color: #991B1B
    }

    [data-theme="dark"] .tc.yes {
      background: #064E3B;
      color: #6EE7B7
    }

    [data-theme="dark"] .tc.no {
      background: #450A0A;
      color: #FCA5A5
    }

    .tc.active-cell {
      outline: 3px solid var(--navy);
      outline-offset: -1px;
      animation: pulse-cell 1.5s ease infinite;
      z-index: 1;
      font-weight: 700;
      font-size: .8rem
    }

    [data-theme="dark"] .tc.active-cell {
      outline-color: var(--gold)
    }

    @keyframes pulse-cell {

      0%,
      100% {
        outline-offset: -1px
      }

      50% {
        outline-offset: 2px
      }
    }

    .tabela-labels {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px
    }

    .tabela-labels span {
      font-size: .7rem;
      color: var(--text3);
      display: flex;
      align-items: center;
      gap: 4px
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 3px;
      display: inline-block
    }

    .dot.g {
      background: #D1FAE5;
      border: 1px solid #065F46
    }

    .dot.r {
      background: #FEE2E2;
      border: 1px solid #991B1B
    }

    .tabela-axis-label {
      text-align: center;
      font-size: .7rem;
      color: var(--text3);
      font-weight: 600
    }

    /* DECISION BANNER */
    .decision {
      text-align: center;
      padding: 20px;
      border-radius: 14px;
      transition: all .4s
    }

    .decision.deferido {
      background: linear-gradient(135deg, #D1FAE5, #A7F3D0);
      border: 2px solid #059669
    }

    .decision.indeferido {
      background: linear-gradient(135deg, #FEE2E2, #FECACA);
      border: 2px solid #DC2626
    }

    .decision.impedimento {
      background: linear-gradient(135deg, #FEF3C7, #FDE68A);
      border: 2px solid #D97706
    }

    [data-theme="dark"] .decision.deferido {
      background: linear-gradient(135deg, #064E3B, #065F46);
      border-color: #10B981
    }

    [data-theme="dark"] .decision.indeferido {
      background: linear-gradient(135deg, #450A0A, #7F1D1D);
      border-color: #F87171
    }

    [data-theme="dark"] .decision.impedimento {
      background: linear-gradient(135deg, #451A03, #78350F);
      border-color: #FBBF24
    }

    .decision-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 4px
    }

    .decision.deferido .decision-icon {
      color: #065F46
    }

    .decision.indeferido .decision-icon {
      color: #991B1B
    }

    .decision.impedimento .decision-icon {
      color: #92400E
    }

    [data-theme="dark"] .decision.deferido .decision-icon {
      color: #6EE7B7
    }

    [data-theme="dark"] .decision.indeferido .decision-icon {
      color: #FCA5A5
    }

    [data-theme="dark"] .decision.impedimento .decision-icon {
      color: #FCD34D
    }

    .decision-label {
      font-family: 'DM Sans', sans-serif;
      font-size: 1.4rem;
      font-weight: 700
    }

    .decision.deferido .decision-label {
      color: #065F46
    }

    .decision.indeferido .decision-label {
      color: #991B1B
    }

    .decision.impedimento .decision-label {
      color: #92400E
    }

    [data-theme="dark"] .decision.deferido .decision-label {
      color: #6EE7B7
    }

    [data-theme="dark"] .decision.indeferido .decision-label {
      color: #FCA5A5
    }

    [data-theme="dark"] .decision.impedimento .decision-label {
      color: #FCD34D
    }

    .decision-reason {
      display: block;
      font-size: .8rem;
      color: var(--text2);
      margin-top: 4px
    }

    .decision-item {
      font-size: .75rem;
      color: var(--text3);
      margin-top: 2px
    }

    /* COMPARISON */
    .comparison {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px
    }

    .comparison h3 {
      font-size: .95rem;
      margin-bottom: 16px;
      text-align: center;
      color: var(--text2)
    }

    /* STANDARD TEXT */
    .standard-text {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px
    }

    .standard-text h3 {
      font-size: .95rem;
      margin-bottom: 8px;
      text-align: center;
      color: var(--text2)
    }

    .standard-text .helper {
      text-align: center;
      font-size: .75rem;
      color: var(--text3);
      margin-bottom: 12px
    }

    .standard-text textarea {
      width: 100%;
      min-height: 220px;
      resize: vertical;
      border: 1.5px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      font-size: .8rem;
      line-height: 1.45;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: var(--bg2);
      color: var(--text)
    }

    .standard-text-actions {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap
    }

    .copy-feedback {
      font-size: .75rem;
      color: var(--text3)
    }

    /* JUDICIAL CONTROL */
    .judicial-control {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px
    }

    .judicial-control h3 {
      font-size: .98rem;
      margin-bottom: 8px;
      text-align: center;
      color: var(--text2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px
    }

    .judicial-control .helper {
      text-align: center;
      font-size: .75rem;
      color: var(--text3);
      margin-bottom: 12px
    }

    .jc-workflow {
      display: flex;
      flex-direction: column;
      gap: 12px
    }

    .jc-progress-wrap {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--surface);
      padding: 8px 10px;
      margin-bottom: 8px
    }

    .jc-progress-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: .74rem;
      color: var(--text2);
      font-weight: 700
    }

    .jc-progress-track {
      height: 6px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--border) 70%, var(--surface));
      overflow: hidden
    }

    .jc-progress-bar {
      height: 100%;
      width: 25%;
      border-radius: 999px;
      background: linear-gradient(90deg, color-mix(in srgb, var(--blue) 70%, #fff), var(--blue));
      transition: width .28s ease
    }

    .jc-why-blocked {
      border: 1px solid #F59E0B;
      background: #FEF3C7;
      color: #92400E;
      border-radius: 9px;
      padding: 8px 10px;
      font-size: .76rem;
      display: flex;
      align-items: flex-start;
      gap: 6px;
      margin-bottom: 8px
    }

    [data-theme="dark"] .jc-why-blocked {
      background: #451A03;
      color: #FCD34D;
      border-color: #F59E0B
    }

    .jc-step {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--bg);
      padding: 12px
    }

    .jc-step.active-step {
      border-color: color-mix(in srgb, var(--blue) 45%, var(--border));
      box-shadow: 0 0 0 1px color-mix(in srgb, var(--blue) 18%, transparent);
      background: color-mix(in srgb, var(--blue) 4%, var(--bg))
    }

    .jc-step-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px
    }

    .jc-step-title {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: 'DM Sans', sans-serif;
      font-weight: 700;
      font-size: .82rem;
      color: var(--text2)
    }

    .jc-step-index {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: color-mix(in srgb, var(--blue) 16%, var(--surface));
      border: 1px solid color-mix(in srgb, var(--blue) 32%, transparent);
      color: var(--blue);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .72rem;
      font-weight: 700
    }

    .jc-step-state {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: .7rem;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 3px 8px;
      color: var(--text3);
      background: var(--surface)
    }

    .jc-step-state.done {
      border-color: #10B981;
      color: #065F46;
      background: #D1FAE5
    }

    .jc-step-state.pending {
      border-color: #F59E0B;
      color: #92400E;
      background: #FEF3C7
    }

    .jc-step-state.blocked {
      border-color: var(--border);
      color: var(--text3);
      background: var(--surface)
    }

    [data-theme="dark"] .jc-step-state.done {
      border-color: #10B981;
      color: #6EE7B7;
      background: #064E3B
    }

    [data-theme="dark"] .jc-step-state.pending {
      border-color: #F59E0B;
      color: #FCD34D;
      background: #451A03
    }

    .jc-step-helper {
      font-size: .76rem;
      color: var(--text3);
      margin-bottom: 10px
    }

    .jc-step-note {
      font-size: .75rem;
      color: var(--text2);
      margin: -2px 0 10px;
      line-height: 1.35
    }

    .jc-qual-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(170px, 1fr));
      gap: 10px;
      margin-bottom: 10px
    }

    .jc-qual-item {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      background: var(--surface)
    }

    .jc-field-title {
      font-size: .74rem;
      font-weight: 700;
      color: var(--text2);
      margin-bottom: 6px;
      line-height: 1.2
    }

    .jc-q-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap
    }

    .jc-q-btn {
      min-width: 36px;
      height: 30px;
      border-radius: 8px;
      border: 1.5px solid var(--border);
      background: var(--surface);
      color: var(--text3);
      font-weight: 700;
      cursor: pointer;
      transition: all .15s
    }

    .jc-q-btn:hover {
      border-color: var(--text3)
    }

    .jc-q-btn.active[data-value="0"] {
      background: var(--qN);
      color: #fff;
      border-color: var(--qN)
    }

    .jc-q-btn.active[data-value="1"] {
      background: var(--qL);
      color: #fff;
      border-color: var(--qL)
    }

    .jc-q-btn.active[data-value="2"] {
      background: var(--qM);
      color: #1a1a1a;
      border-color: var(--qM)
    }

    .jc-q-btn.active[data-value="3"] {
      background: var(--qG);
      color: #fff;
      border-color: var(--qG)
    }

    .jc-q-btn.active[data-value="4"] {
      background: var(--qC);
      color: #fff;
      border-color: var(--qC)
    }

    .jc-inline-note {
      font-size: .77rem;
      color: var(--text2);
      border: 1px dashed var(--border);
      border-radius: 8px;
      padding: 8px;
      margin-top: 8px;
      background: var(--surface)
    }

    .jc-actions-main {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center
    }

    .jc-actions-main .btn {
      padding: 8px 12px;
      font-size: .78rem
    }

    .jc-primary-btn {
      box-shadow: 0 2px 8px rgba(197, 165, 90, .28)
    }

    .jc-autofill-details {
      margin-top: 8px;
      border: 1px dashed var(--border);
      border-radius: 8px;
      background: var(--surface);
      padding: 8px
    }

    .jc-autofill-details summary {
      cursor: pointer;
      font-size: .75rem;
      color: var(--text2);
      font-weight: 700
    }

    .jc-autofill-body {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center
    }

    .jc-autofill-hint {
      font-size: .74rem;
      color: var(--text3);
      flex: 1 1 280px
    }

    .jc-autofill-btn {
      background: transparent;
      color: var(--text2);
      border: 1px dashed var(--border);
      padding: 7px 10px;
      font-size: .75rem
    }

    .jc-autofill-btn:hover {
      border-color: color-mix(in srgb, var(--blue) 35%, var(--border));
      color: var(--blue);
      background: color-mix(in srgb, var(--blue) 6%, var(--surface))
    }

    .jc-segmented {
      display: inline-flex;
      border: 1.5px solid var(--border);
      border-radius: 9px;
      overflow: hidden;
      background: var(--surface)
    }

    .jc-seg-btn {
      min-width: 68px;
      height: 32px;
      border: none;
      border-right: 1px solid var(--border);
      background: var(--surface);
      color: var(--text2);
      font-weight: 700;
      cursor: pointer;
      font-size: .78rem
    }

    .jc-seg-btn:last-child {
      border-right: none
    }

    .jc-seg-btn.active {
      background: var(--blue);
      color: #fff
    }

    .jc-seg-btn:disabled {
      cursor: not-allowed;
      color: var(--text3);
      background: color-mix(in srgb, var(--border) 18%, var(--surface));
      opacity: .75
    }

    .jc-segmented-wide {
      width: 100%;
      border: none;
      background: transparent;
      gap: 6px;
      flex-wrap: wrap
    }

    .jc-segmented-wide .jc-seg-btn {
      flex: 1 1 220px;
      min-width: 180px;
      height: auto;
      line-height: 1.25;
      padding: 8px 10px;
      border: 1.5px solid var(--border);
      border-right: 1.5px solid var(--border);
      border-radius: 8px
    }

    .jc-segmented-wide .jc-seg-btn:last-child {
      border-right: 1.5px solid var(--border)
    }

    .jc-med-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(220px, 1fr));
      gap: 10px
    }

    .jc-field {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      background: var(--surface)
    }

    .jc-field-span-2 {
      grid-column: 1 / -1
    }

    .jc-field-helper {
      font-size: .72rem;
      color: var(--text3);
      margin-top: 6px;
      line-height: 1.35
    }

    .jc-ativ-mode-block {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px dashed var(--border)
    }

    .jc-field-title-margin {
      margin-top: 8px
    }

    .jc-mini-textarea {
      width: 100%;
      min-height: 74px;
      resize: vertical;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      font-size: .76rem;
      line-height: 1.35;
      font-family: inherit;
      background: var(--bg2);
      color: var(--text)
    }

    .jc-select {
      width: 100%;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: .76rem;
      background: var(--surface);
      color: var(--text2)
    }

    .jc-complete-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(150px, 1fr));
      gap: 8px;
      margin-top: 6px
    }

    .jc-complete-item {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 7px;
      background: var(--bg)
    }

    .jc-complete-item .jc-field-title {
      font-size: .7rem
    }

    .jc-trace {
      margin-top: 8px;
      font-size: .78rem;
      color: var(--text2);
      line-height: 1.45;
      display: flex;
      flex-direction: column;
      gap: 4px
    }

    .jc-trace-line {
      border-left: 2px solid var(--border);
      padding-left: 8px
    }

    .jc-status-badge {
      border-radius: 9px;
      border: 1.5px solid var(--border);
      background: var(--surface);
      padding: 10px 12px;
      font-family: 'DM Sans', sans-serif;
      font-size: .8rem;
      color: var(--text2)
    }

    .jc-status-badge.dispensa {
      border-color: #10B981;
      color: #065F46;
      background: #D1FAE5
    }

    .jc-status-badge.necessaria {
      border-color: #EF4444;
      color: #991B1B;
      background: #FEE2E2
    }

    .jc-status-badge.pending {
      border-color: #F59E0B;
      color: #92400E;
      background: #FEF3C7
    }

    [data-theme="dark"] .jc-status-badge.dispensa {
      border-color: #10B981;
      color: #6EE7B7;
      background: #064E3B
    }

    [data-theme="dark"] .jc-status-badge.necessaria {
      border-color: #F87171;
      color: #FCA5A5;
      background: #450A0A
    }

    [data-theme="dark"] .jc-status-badge.pending {
      border-color: #F59E0B;
      color: #FCD34D;
      background: #451A03
    }

    .jc-textarea {
      width: 100%;
      min-height: 210px;
      resize: vertical;
      border: 1.5px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      font-size: .8rem;
      line-height: 1.45;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: var(--bg2);
      color: var(--text)
    }

    .jc-admin-rec-wrap {
      margin-top: 8px;
      border: 1px dashed var(--border);
      border-radius: 8px;
      background: var(--surface);
      padding: 8px
    }

    .jc-help-details {
      margin-top: 8px;
      border: 1px dashed var(--border);
      border-radius: 8px;
      background: color-mix(in srgb, var(--blue) 4%, var(--surface));
      padding: 8px
    }

    .jc-help-details summary {
      cursor: pointer;
      font-size: .75rem;
      color: var(--text2);
      font-weight: 700
    }

    .jc-help-grid {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(2, minmax(220px, 1fr));
      gap: 8px
    }

    .jc-help-item {
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface);
      padding: 8px
    }

    .jc-help-title {
      font-size: .74rem;
      font-weight: 700;
      color: var(--text2);
      margin-bottom: 4px
    }

    .jc-help-item p {
      font-size: .73rem;
      color: var(--text2);
      line-height: 1.45
    }

    .jc-help-item p + p {
      margin-top: 5px
    }

    .jc-reduction-alert {
      margin-top: 8px;
      border: 1px solid #F59E0B;
      background: #FFFBEB;
      color: #92400E;
      border-radius: 8px;
      padding: 8px;
      font-size: .74rem;
      display: flex;
      flex-direction: column;
      gap: 6px
    }

    .jc-reduction-alert label {
      display: inline-flex;
      align-items: center;
      gap: 6px
    }

    [data-theme="dark"] .jc-reduction-alert {
      border-color: #F59E0B;
      background: #451A03;
      color: #FCD34D
    }

    .jc-social-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(180px, 1fr));
      gap: 8px
    }

    .jc-social-item {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 7px;
      background: var(--bg)
    }

    .jc-social-item .jc-field-title {
      font-size: .7rem
    }

    @media(max-width:900px) {
      .jc-qual-grid {
        grid-template-columns: 1fr
      }

      .jc-med-grid {
        grid-template-columns: 1fr
      }

      .jc-social-grid {
        grid-template-columns: 1fr
      }

      .jc-complete-grid {
        grid-template-columns: repeat(2, minmax(150px, 1fr))
      }

      .jc-help-grid {
        grid-template-columns: 1fr
      }

      .jc-actions-main .jc-primary-btn,
      .jc-autofill-btn {
        width: 100%;
        justify-content: center
      }
    }

    .comp-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px
    }

    @media(max-width:600px) {
      .comp-grid {
        grid-template-columns: 1fr
      }

      .jc-complete-grid {
        grid-template-columns: 1fr
      }
    }

    .comp-card {
      padding: 16px;
      border-radius: 10px;
      text-align: center
    }

    .comp-card.inss {
      background: #FEF3C7;
      border: 1.5px solid #F59E0B
    }

    .comp-card.pericia {
      background: #DBEAFE;
      border: 1.5px solid #3B82F6
    }

    [data-theme="dark"] .comp-card.inss {
      background: #451A03;
      border-color: #F59E0B
    }

    [data-theme="dark"] .comp-card.pericia {
      background: #1E2A4A;
      border-color: #3B82F6
    }

    .comp-title {
      font-family: 'DM Sans', sans-serif;
      font-weight: 700;
      font-size: .85rem;
      margin-bottom: 8px
    }

    .comp-quals {
      font-size: .8rem;
      color: var(--text2);
      margin-bottom: 8px
    }

    .comp-result {
      font-family: 'DM Sans', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px
    }

    .comp-result .ui-icon {
      width: .95em;
      height: .95em
    }

    .comp-result.yes {
      color: var(--yes)
    }

    .comp-result.no {
      color: var(--no)
    }

    .comp-change {
      margin-top: 8px;
      font-size: .75rem;
      color: var(--text3)
    }

    /* FOOTER */
    .footer-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap
    }

    footer {
      text-align: center;
      padding: 20px;
      color: var(--text3);
      font-size: .75rem
    }

    footer p {
      margin-bottom: 4px
    }

    /* ANIMATION */
    @keyframes pop {
      0% {
        transform: scale(1)
      }

      50% {
        transform: scale(1.08)
      }

      100% {
        transform: scale(1)
      }
    }

    .pop {
      animation: pop .3s ease
    }
  </style>
</head>

<body>
  <div class="app">
    <svg class="icon-sprite" aria-hidden="true">
      <symbol id="i-balance" viewBox="0 0 24 24">
        <path d="M4 7h16" />
        <path d="M12 7v10" />
        <path d="M8 17h8" />
        <path d="M5 7 2.5 11h5z" />
        <path d="M19 7 16.5 11h5z" />
        <path d="M2.5 11c0 1.7 1.3 3 3 3s3-1.3 3-3" />
        <path d="M16.5 11c0 1.7 1.3 3 3 3s3-1.3 3-3" />
      </symbol>
      <symbol id="i-moon" viewBox="0 0 24 24">
        <path d="M20 14.5A8 8 0 1 1 9.5 4 6.5 6.5 0 0 0 20 14.5z" />
      </symbol>
      <symbol id="i-child" viewBox="0 0 24 24">
        <rect x="2.5" y="5.5" width="19" height="13" rx="2" />
        <circle cx="8.5" cy="11.2" r="1.8" />
        <path d="M5.9 15.4c.6-1.4 1.5-2.1 2.6-2.1s2 .7 2.6 2.1" />
        <path d="M14 10h4.5" />
        <path d="M14 13h4.5" />
      </symbol>
      <symbol id="i-chart" viewBox="0 0 24 24">
        <path d="M4 20h16" />
        <rect x="5" y="12" width="3" height="6" rx="1" />
        <rect x="10.5" y="9" width="3" height="9" rx="1" />
        <rect x="16" y="6" width="3" height="12" rx="1" />
      </symbol>
      <symbol id="i-trash" viewBox="0 0 24 24">
        <path d="M4 7h16" />
        <path d="M9 7V5h6v2" />
        <path d="M7 7l1 12h8l1-12" />
        <path d="M10 10v6" />
        <path d="M14 10v6" />
      </symbol>
      <symbol id="i-alert" viewBox="0 0 24 24">
        <path d="M12 3 2.8 19h18.4L12 3z" />
        <path d="M12 9v4" />
        <circle cx="12" cy="15.2" r=".9" fill="currentColor" stroke="none" />
      </symbol>
      <symbol id="i-home" viewBox="0 0 24 24">
        <path d="M3.5 10.5 12 4l8.5 6.5" />
        <path d="M5 9.8V20h14V9.8" />
        <path d="M10 20v-5h4v5" />
      </symbol>
      <symbol id="i-stethoscope" viewBox="0 0 24 24">
        <path d="M7 4v5a3 3 0 0 0 6 0V4" />
        <path d="M7 6h6" />
        <path d="M13 10v3a4 4 0 0 0 8 0v-2" />
        <circle cx="21" cy="10.5" r="1.5" />
      </symbol>
      <symbol id="i-network" viewBox="0 0 24 24">
        <circle cx="6" cy="12" r="2" />
        <circle cx="18" cy="7" r="2" />
        <circle cx="18" cy="17" r="2" />
        <path d="M8 12h5" />
        <path d="M13 12 16.2 8.8" />
        <path d="M13 12 16.2 15.2" />
      </symbol>
      <symbol id="i-save" viewBox="0 0 24 24">
        <path d="M5 4h11l3 3v13H5z" />
        <path d="M8 4v6h8V6.5L13.5 4z" />
        <rect x="8" y="14" width="8" height="5" rx="1" />
      </symbol>
      <symbol id="i-document" viewBox="0 0 24 24">
        <path d="M7 3h7l4 4v14H7z" />
        <path d="M14 3v4h4" />
        <path d="M10 12h6" />
        <path d="M10 15h6" />
      </symbol>
      <symbol id="i-close" viewBox="0 0 24 24">
        <path d="M6 6 18 18" />
        <path d="M18 6 6 18" />
      </symbol>
      <symbol id="i-clipboard" viewBox="0 0 24 24">
        <rect x="6" y="5" width="12" height="16" rx="2" />
        <path d="M9 5.5h6V4a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1z" />
        <path d="M9 10h6" />
        <path d="M9 13h6" />
      </symbol>
      <symbol id="i-check-circle" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="9" />
        <path d="m8 12 2.6 2.7L16.5 9" />
      </symbol>
      <symbol id="i-x-circle" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="9" />
        <path d="m9 9 6 6" />
        <path d="m15 9-6 6" />
      </symbol>
      <symbol id="i-swap" viewBox="0 0 24 24">
        <path d="M4 8h11" />
        <path d="m12 5 3 3-3 3" />
        <path d="M20 16H9" />
        <path d="m12 13-3 3 3 3" />
      </symbol>
    </svg>
    <header>
      <span class="badge"><svg class="ui-icon sm" aria-hidden="true"><use href="#i-balance"></use></svg>BPC / LOAS</span>
      <h1>Calculadora Biopsicossocial</h1>
      <p>Portaria Conjunta MDS/INSS nº 2/2015 · Tabela Conclusiva (Anexo IV)</p>
      <div class="app-mode-switch" id="modeSwitcher" aria-label="Modo da aplicação">
        <button class="mode-btn" data-mode="simulador">Simulador</button>
        <button class="mode-btn" data-mode="controle">Controle Judicial</button>
      </div>
      <div class="header-row">
        <label><input type="checkbox" id="toggleDark"><svg class="ui-icon sm" aria-hidden="true"><use href="#i-moon"></use></svg>Modo escuro</label>
        <label><input type="checkbox" id="toggleMenor16"><svg class="ui-icon sm" aria-hidden="true"><use href="#i-child"></use></svg>Idade inferior a 16 anos</label>
        <span class="idade-input hidden" id="idadeWrap">Idade:
          <input type="number" id="inputIdade" min="0" max="15" step="1" value="15" inputmode="numeric">
          <select id="inputIdadeUnidade">
            <option value="anos" selected>anos</option>
            <option value="meses">meses</option>
          </select>
          <strong id="faixaEtaria" class="idade-status"></strong>
        </span>
        <span class="idade-status hidden" id="childAutoSummary"></span>
      </div>
    </header>

    <details id="simuladorDetails" class="simulador-details" open>
      <summary class="simulador-summary">Calculadora (consulta rápida)</summary>
      <div class="simulador-body">
        <div class="toolbar">
          <button class="btn btn-gold" id="btnPadrao"><svg class="ui-icon sm" aria-hidden="true"><use href="#i-chart"></use></svg>Aplicar Padrão Médio Social</button>
          <button class="btn btn-outline" id="btnLimpar"><svg class="ui-icon sm" aria-hidden="true"><use href="#i-trash"></use></svg>Limpar</button>
          <label class="toggle-label">
            <input type="checkbox" id="togglePadraoOverwrite"><span class="toggle-switch"></span><svg class="ui-icon sm" aria-hidden="true"><use href="#i-swap"></use></svg>
            Sobrescrever domínios preenchidos
          </label>
          <label class="toggle-label">
            <input type="checkbox" id="toggleImpedimento"><span class="toggle-switch"></span><svg class="ui-icon sm" aria-hidden="true"><use href="#i-alert"></use></svg>
            Impedimento &lt; 2 anos
          </label>
        </div>

        <main class="calculator">
      <!-- Panel Ambiente -->
      <section class="panel" style="--panel-color:#2563EB">
        <div class="panel-header">
          <div class="panel-icon"><svg class="ui-icon" aria-hidden="true"><use href="#i-home"></use></svg></div>
          <div>
            <h2>Fatores Ambientais</h2>
            <div class="sub">Avaliação Social · 5 domínios (e1–e5)</div>
          </div>
        </div>
        <div class="domains" id="domAmb"></div>
        <div class="panel-result">
          <div class="formula" id="fAmb"></div>
          <div class="result-bar">
            <div class="result-fill" id="barAmb"></div>
          </div>
          <div class="panel-result-row"><span class="qual-name" id="nameAmb">Nenhuma Barreira</span>
            <div class="qualifier-badge" id="qAmb" data-q="N">N</div>
          </div>
        </div>
      </section>
      <!-- Panel Corpo -->
      <section class="panel" style="--panel-color:#DC2626">
        <div class="panel-header">
          <div class="panel-icon"><svg class="ui-icon" aria-hidden="true"><use href="#i-stethoscope"></use></svg></div>
          <div>
            <h2>Funções do Corpo</h2>
            <div class="sub">Avaliação Médica · 8 domínios (b1–b8)</div>
          </div>
        </div>
        <div class="domains" id="domCorpo"></div>
        <div class="majoracao-toggles">
          <label class="toggle-label"><input type="checkbox" id="toggleProg"><span
              class="toggle-switch"></span>Prognóstico desfavorável</label>
          <label class="toggle-label"><input type="checkbox" id="toggleEstr"><span
              class="toggle-switch"></span>Estrutura do Corpo &gt; Função</label>
        </div>
        <div class="panel-result">
          <div class="formula" id="fCorpo"></div>
          <div class="panel-result-row"><span class="qual-name" id="nameCorpo">Nenhuma Alteração</span>
            <div class="qualifier-badge" id="qCorpo" data-q="N">N</div>
          </div>
        </div>
      </section>
      <!-- Panel Atividades -->
      <section class="panel" style="--panel-color:#7C3AED">
        <div class="panel-header">
          <div class="panel-icon"><svg class="ui-icon" aria-hidden="true"><use href="#i-network"></use></svg></div>
          <div>
            <h2>Atividades e Participação</h2>
            <div class="sub">Misto · 9 domínios (d1–d9)</div>
          </div>
        </div>
        <div class="domains">
          <div class="section-label"><span class="badge-m">Perito Médico</span> d1–d5</div>
          <div id="domAtivM"></div>
          <div class="section-label"><span class="badge-s">Assistente Social</span> d6–d9</div>
          <div id="domAtivS"></div>
        </div>
        <div class="panel-result">
          <div class="formula" id="fAtiv"></div>
          <div class="result-bar">
            <div class="result-fill" id="barAtiv"></div>
          </div>
          <div class="panel-result-row"><span class="qual-name" id="nameAtiv">Nenhuma Dificuldade</span>
            <div class="qualifier-badge" id="qAtiv" data-q="N">N</div>
          </div>
        </div>
      </section>
        </main>

        <section class="resultado" id="resultado">
      <h2>Resultado da Avaliação</h2>
      <div class="qualifiers-row">
        <div class="qual-card"><span class="qual-label">Fatores Ambientais</span>
          <div class="qualifier-badge large" id="rAmb" data-q="N">N</div><span class="qual-desc"
            id="dAmb">Nenhuma</span>
        </div>
        <span class="qual-sep">×</span>
        <div class="qual-card"><span class="qual-label">Atividades e Participação</span>
          <div class="qualifier-badge large" id="rAtiv" data-q="N">N</div><span class="qual-desc"
            id="dAtiv">Nenhuma</span>
        </div>
        <span class="qual-sep">×</span>
        <div class="qual-card"><span class="qual-label">Funções do Corpo</span>
          <div class="qualifier-badge large" id="rCorpo" data-q="N">N</div><span class="qual-desc"
            id="dCorpo">Nenhuma</span>
        </div>
      </div>
      <div class="tabela-section">
        <h3>Tabela Conclusiva — Anexo IV, Portaria 2/2015</h3>
        <div class="amb-tabs"><span class="amb-tab-label">Ambiente:</span><button class="amb-tab active"
            data-a="0">N</button><button class="amb-tab" data-a="1">L</button><button class="amb-tab"
            data-a="2">M</button><button class="amb-tab" data-a="3">G</button><button class="amb-tab"
            data-a="4">C</button></div>
        <div class="tabela-axis-label">↓ Funções do Corpo × Atividades e Participação →</div>
        <div class="tabela-grid" id="tGrid"></div>
        <div class="tabela-labels"><span><span class="dot g"></span> Deferido (Sim)</span><span><span
              class="dot r"></span> Indeferido (Não)</span></div>
      </div>
      <div class="decision indeferido" id="decision">
        <div class="decision-icon" id="decIcon"><svg class="ui-icon lg" aria-hidden="true"><use href="#i-alert"></use></svg></div>
        <div class="decision-label" id="decLabel">AGUARDANDO DADOS</div>
        <span class="decision-reason" id="decReason">Insira as notas nos domínios acima</span>
        <span class="decision-item" id="decItem"></span>
      </div>
        </section>
      </div>
    </details>

    <div class="footer-actions">
      <button class="btn btn-outline" id="btnSaveINSS"><svg class="ui-icon sm" aria-hidden="true"><use href="#i-save"></use></svg>Fixar base pelos qualificadores atuais</button>
      <button class="btn btn-outline" id="btnGerarTexto"><svg class="ui-icon sm" aria-hidden="true"><use href="#i-document"></use></svg>Gerar texto padronizado</button>
      <button class="btn btn-red hidden" id="btnClearComp"><svg class="ui-icon sm" aria-hidden="true"><use href="#i-close"></use></svg>Limpar comparação</button>
    </div>
    <div class="standard-text hidden" id="textoSection">
      <h3>Minuta Padronizada para Decisão</h3>
      <p class="helper">Texto automático para copiar e colar na fundamentação sobre o enquadramento da parte autora no conceito de pessoa com deficiência para fins de BPC/LOAS.</p>
      <textarea id="textoPadrao" readonly></textarea>
      <div class="standard-text-actions">
        <span class="copy-feedback" id="copyFeedback"></span>
        <button class="btn btn-outline" id="btnCopiarTexto"><svg class="ui-icon sm" aria-hidden="true"><use href="#i-clipboard"></use></svg>Copiar texto</button>
      </div>
    </div>
    <div class="comparison hidden" id="compSection">
      <h3>Comparação: Avaliação INSS × Reclassificação Judicial</h3>
      <div class="comp-grid">
        <div class="comp-card inss">
          <div class="comp-title">Avaliação INSS</div>
          <div class="comp-quals" id="compINSSq"></div>
          <div class="comp-result" id="compINSSr"></div>
        </div>
        <div class="comp-card pericia">
          <div class="comp-title">Reclassificação Judicial</div>
          <div class="comp-quals" id="compPERq"></div>
          <div class="comp-result" id="compPERr"></div>
        </div>
      </div>
      <div class="comp-change" id="compChange"></div>
    </div>
    <div class="judicial-control" id="judicialControlSection">
      <h3><svg class="ui-icon sm" aria-hidden="true"><use href="#i-balance"></use></svg>Controle Judicial</h3>
      <p class="helper">Fluxo probatório para decidir se basta perícia médica judicial ou se também é necessária avaliação social.</p>
      <div class="jc-progress-wrap" id="jcProgressWrap">
        <div class="jc-progress-head">
          <span id="jcProgressLabel">Etapa 1 de 4 · Base administrativa</span>
          <span id="jcProgressPct">25%</span>
        </div>
        <div class="jc-progress-track">
          <div class="jc-progress-bar" id="jcProgressBar"></div>
        </div>
      </div>
      <div class="jc-why-blocked hidden" id="jcWhyBlocked"><svg class="ui-icon sm" aria-hidden="true"><use href="#i-alert"></use></svg><span></span></div>
      <div class="jc-workflow">
        <section class="jc-step" id="stepAdmin">
          <div class="jc-step-header">
            <div class="jc-step-title"><span class="jc-step-index">1</span>Fixar avaliação administrativa (INSS)</div>
            <span class="jc-step-state pending" id="jcAdminState">Pendente</span>
          </div>
          <p class="jc-step-helper">Informe os qualificadores finais da fase administrativa e os reconhecimentos prévios do INSS para Funções do Corpo.</p>
          <p class="jc-step-note">O que fazer: escolha os 3 qualificadores finais administrativos, informe os reconhecimentos administrativos de Funções e clique em <strong>Fixar base administrativa</strong>. Se necessário, use o atalho opcional para preencher os qualificadores a partir da Calculadora.</p>
          <div class="jc-qual-grid">
            <div class="jc-qual-item">
              <div class="jc-field-title">Fatores Ambientais (final)</div>
              <div class="jc-q-buttons" id="jcAdminAmbButtons">
                <button class="jc-q-btn" data-value="0">N</button>
                <button class="jc-q-btn" data-value="1">L</button>
                <button class="jc-q-btn" data-value="2">M</button>
                <button class="jc-q-btn" data-value="3">G</button>
                <button class="jc-q-btn" data-value="4">C</button>
              </div>
            </div>
            <div class="jc-qual-item">
              <div class="jc-field-title">Atividades e Participação (final)</div>
              <div class="jc-q-buttons" id="jcAdminAtivButtons">
                <button class="jc-q-btn" data-value="0">N</button>
                <button class="jc-q-btn" data-value="1">L</button>
                <button class="jc-q-btn" data-value="2">M</button>
                <button class="jc-q-btn" data-value="3">G</button>
                <button class="jc-q-btn" data-value="4">C</button>
              </div>
            </div>
            <div class="jc-qual-item">
              <div class="jc-field-title">Funções do Corpo (final)</div>
              <div class="jc-q-buttons" id="jcAdminCorpoButtons">
                <button class="jc-q-btn" data-value="0">N</button>
                <button class="jc-q-btn" data-value="1">L</button>
                <button class="jc-q-btn" data-value="2">M</button>
                <button class="jc-q-btn" data-value="3">G</button>
                <button class="jc-q-btn" data-value="4">C</button>
              </div>
            </div>
          </div>
          <div class="jc-admin-rec-wrap">
            <div class="jc-field-title">Reconhecimentos administrativos do INSS (Funções do Corpo)</div>
            <p class="jc-field-helper">Essas respostas controlam os motivos permitidos na requalificação judicial de Funções do Corpo.</p>
            <div class="jc-social-grid">
              <div class="jc-social-item">
                <div class="jc-field-title">INSS reconheceu alterações em estruturas do corpo que configurem maiores limitações ou restrições ao avaliado do que as alterações observadas em Funções do Corpo?</div>
                <div class="jc-segmented" id="jcAdminEstruturasRecButtons">
                  <button class="jc-seg-btn" data-value="sim">Sim</button>
                  <button class="jc-seg-btn" data-value="nao">Não</button>
                </div>
              </div>
              <div class="jc-social-item">
                <div class="jc-field-title">INSS reconheceu prognóstico desfavorável?</div>
                <div class="jc-segmented" id="jcAdminProgRecButtons">
                  <button class="jc-seg-btn" data-value="sim">Sim</button>
                  <button class="jc-seg-btn" data-value="nao">Não</button>
                </div>
              </div>
            </div>
            <details class="jc-help-details">
              <summary>Não sabe como responder? Ver explicação</summary>
              <div class="jc-help-grid">
                <article class="jc-help-item">
                  <div class="jc-help-title">Estruturas do corpo mais limitantes que Funções</div>
                  <p>Use esta resposta para registrar se o INSS já reconheceu, na fase administrativa, alterações anatômicas (órgãos, membros ou estruturas) com impacto maior do que o captado no qualificador de Funções do Corpo.</p>
                  <p><strong>Marque “Sim”</strong> quando o próprio material administrativo do INSS já apontar esse descompasso.</p>
                  <p><strong>Exemplos de “Sim”:</strong> amputação extensa, deformidade estrutural grave ou lesão anatômica permanente que imponha restrição superior à indicada no qualificador final de Funções.</p>
                  <p><strong>Exemplos de “Não”:</strong> quando o INSS não reconheceu esse ponto, ou quando as alterações estruturais já estão proporcionais ao qualificador de Funções atribuído.</p>
                </article>
                <article class="jc-help-item">
                  <div class="jc-help-title">Prognóstico desfavorável</div>
                  <p>A Portaria pergunta apenas se as alterações configuram prognóstico desfavorável, sem exigir literalmente “piora” em todos os casos.</p>
                  <p><strong>Manutenção isolada não basta automaticamente.</strong> Marque “Sim” quando o INSS tiver reconhecido, de forma técnica, curso funcional desfavorável: tendência de piora <strong>ou</strong> persistência relevante sem expectativa concreta de recuperação funcional significativa.</p>
                  <p><strong>Exemplos de “Sim”:</strong> doença progressiva com perda funcional contínua; quadro crônico grave/irreversível com limitação importante e sem perspectiva real de reabilitação relevante.</p>
                  <p><strong>Exemplos de “Não”:</strong> quadro estável com possibilidade real de melhora funcional; ou situação em que o INSS não tenha feito esse reconhecimento no ato administrativo.</p>
                </article>
              </div>
            </details>
          </div>
          <details class="jc-autofill-details hidden" id="jcAutoFillDetails">
            <summary>Atalho opcional: preencher rascunho com a Calculadora</summary>
            <div class="jc-autofill-body">
              <p class="jc-autofill-hint" id="jcAutoFillHint"></p>
              <button class="btn jc-autofill-btn" id="btnUseCurrentAsBase"><svg class="ui-icon sm" aria-hidden="true"><use href="#i-swap"></use></svg>Preencher automaticamente com a Calculadora</button>
            </div>
          </details>
          <div class="jc-inline-note" id="jcAdminFixedSummary">Base administrativa ainda não fixada.</div>
          <div class="jc-actions-main">
            <button class="btn btn-gold jc-primary-btn" id="btnFixarBaseAdmin"><svg class="ui-icon sm" aria-hidden="true"><use href="#i-save"></use></svg>Fixar base administrativa</button>
          </div>
        </section>

        <section class="jc-step" id="stepMed">
          <div class="jc-step-header">
            <div class="jc-step-title"><span class="jc-step-index">2</span>Informações da perícia médica judicial</div>
            <span class="jc-step-state blocked" id="jcMedState">Bloqueada</span>
          </div>
          <p class="jc-step-helper">Preencha os campos mínimos da perícia médica para liberar a triagem probatória.</p>
          <p class="jc-step-note">O que fazer: informe impedimento de longo prazo, decida se mantém Funções do Corpo administrativas e, se necessário, requalifique com motivo fechado.</p>
          <div class="jc-med-grid">
            <div class="jc-field">
              <div class="jc-field-title">Impedimento de longo prazo</div>
              <div class="jc-segmented" id="jcImpedimentoButtons">
                <button class="jc-seg-btn" data-value="sim">Sim</button>
                <button class="jc-seg-btn" data-value="nao">Não</button>
              </div>
            </div>
            <div class="jc-field jc-field-span-2">
              <div class="jc-field-title">Funções do Corpo (judicial)</div>
              <div class="jc-segmented jc-segmented-wide" id="jcCorpoKeepButtons">
                <button class="jc-seg-btn" data-value="sim">Manter qualificador administrativo</button>
                <button class="jc-seg-btn" data-value="nao">Alterar na fase judicial</button>
              </div>
              <p class="jc-field-helper">Se optar por alterar, escolha um motivo fechado. O sistema aplicará a regra correspondente para definir o qualificador judicial.</p>
              <div class="jc-ativ-mode-block hidden" id="jcCorpoChangeWrap">
                <label class="jc-field-title" for="jcCorpoReasonSelect">Motivo da alteração (seleção única)</label>
                <select id="jcCorpoReasonSelect" class="jc-select">
                  <option value="">Selecione o motivo</option>
                  <option value="estruturas">Estruturas do corpo mais graves (não reconhecidas pelo INSS)</option>
                  <option value="prognostico">Prognóstico desfavorável (não reconhecido pelo INSS)</option>
                  <option value="dominio_max">Domínio administrativo b1–b8 mais grave</option>
                  <option value="rebaixamento">Rebaixamento por prova superveniente</option>
                </select>
                <p class="jc-field-helper" id="jcCorpoReasonHint"></p>
                <div class="jc-ativ-mode-block hidden" id="jcCorpoDomainWrap">
                  <div class="jc-field-title">Pontuação administrativa dos domínios b1–b8</div>
                  <p class="jc-field-helper">Informe o(s) domínio(s) necessário(s). Para este motivo, vale o domínio administrativo mais grave entre os informados.</p>
                  <div class="jc-complete-grid">
                    <div class="jc-complete-item">
                      <div class="jc-field-title">b1 · Funções Mentais</div>
                      <div class="jc-q-buttons" id="jcCorpoB1Buttons">
                        <button class="jc-q-btn" data-value="0">N</button>
                        <button class="jc-q-btn" data-value="1">L</button>
                        <button class="jc-q-btn" data-value="2">M</button>
                        <button class="jc-q-btn" data-value="3">G</button>
                        <button class="jc-q-btn" data-value="4">C</button>
                      </div>
                    </div>
                    <div class="jc-complete-item">
                      <div class="jc-field-title">b2 · Visão</div>
                      <div class="jc-q-buttons" id="jcCorpoB2Buttons">
                        <button class="jc-q-btn" data-value="0">N</button>
                        <button class="jc-q-btn" data-value="1">L</button>
                        <button class="jc-q-btn" data-value="2">M</button>
                        <button class="jc-q-btn" data-value="3">G</button>
                        <button class="jc-q-btn" data-value="4">C</button>
                      </div>
                    </div>
                    <div class="jc-complete-item">
                      <div class="jc-field-title">b3 · Audição</div>
                      <div class="jc-q-buttons" id="jcCorpoB3Buttons">
                        <button class="jc-q-btn" data-value="0">N</button>
                        <button class="jc-q-btn" data-value="1">L</button>
                        <button class="jc-q-btn" data-value="2">M</button>
                        <button class="jc-q-btn" data-value="3">G</button>
                        <button class="jc-q-btn" data-value="4">C</button>
                      </div>
                    </div>
                    <div class="jc-complete-item">
                      <div class="jc-field-title">b4 · Dor e Sensações</div>
                      <div class="jc-q-buttons" id="jcCorpoB4Buttons">
                        <button class="jc-q-btn" data-value="0">N</button>
                        <button class="jc-q-btn" data-value="1">L</button>
                        <button class="jc-q-btn" data-value="2">M</button>
                        <button class="jc-q-btn" data-value="3">G</button>
                        <button class="jc-q-btn" data-value="4">C</button>
                      </div>
                    </div>
                    <div class="jc-complete-item">
                      <div class="jc-field-title">b5 · Voz e Fala</div>
                      <div class="jc-q-buttons" id="jcCorpoB5Buttons">
                        <button class="jc-q-btn" data-value="0">N</button>
                        <button class="jc-q-btn" data-value="1">L</button>
                        <button class="jc-q-btn" data-value="2">M</button>
                        <button class="jc-q-btn" data-value="3">G</button>
                        <button class="jc-q-btn" data-value="4">C</button>
                      </div>
                    </div>
                    <div class="jc-complete-item">
                      <div class="jc-field-title">b6 · Cardiovascular / Respiratório</div>
                      <div class="jc-q-buttons" id="jcCorpoB6Buttons">
                        <button class="jc-q-btn" data-value="0">N</button>
                        <button class="jc-q-btn" data-value="1">L</button>
                        <button class="jc-q-btn" data-value="2">M</button>
                        <button class="jc-q-btn" data-value="3">G</button>
                        <button class="jc-q-btn" data-value="4">C</button>
                      </div>
                    </div>
                    <div class="jc-complete-item">
                      <div class="jc-field-title">b7 · Digestivo / Metabólico</div>
                      <div class="jc-q-buttons" id="jcCorpoB7Buttons">
                        <button class="jc-q-btn" data-value="0">N</button>
                        <button class="jc-q-btn" data-value="1">L</button>
                        <button class="jc-q-btn" data-value="2">M</button>
                        <button class="jc-q-btn" data-value="3">G</button>
                        <button class="jc-q-btn" data-value="4">C</button>
                      </div>
                    </div>
                    <div class="jc-complete-item">
                      <div class="jc-field-title">b8 · Neuromusculoesquelético</div>
                      <div class="jc-q-buttons" id="jcCorpoB8Buttons">
                        <button class="jc-q-btn" data-value="0">N</button>
                        <button class="jc-q-btn" data-value="1">L</button>
                        <button class="jc-q-btn" data-value="2">M</button>
                        <button class="jc-q-btn" data-value="3">G</button>
                        <button class="jc-q-btn" data-value="4">C</button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="jc-ativ-mode-block hidden" id="jcCorpoManualWrap">
                  <div class="jc-field-title">Qualificador judicial manual (rebaixamento)</div>
                  <div class="jc-q-buttons" id="jcCorpoManualButtons">
                    <button class="jc-q-btn" data-value="0">N</button>
                    <button class="jc-q-btn" data-value="1">L</button>
                    <button class="jc-q-btn" data-value="2">M</button>
                    <button class="jc-q-btn" data-value="3">G</button>
                    <button class="jc-q-btn" data-value="4">C</button>
                  </div>
                </div>
                <div class="jc-reduction-alert hidden" id="jcCorpoReductionAlert">
                  <strong>Atenção:</strong> o qualificador judicial ficou inferior ao administrativo. Confirme para prosseguir.
                  <label><input type="checkbox" id="jcCorpoReductionConfirm"> Confirmo a redução com base na prova superveniente</label>
                </div>
              </div>
              <div class="jc-inline-note" id="jcCorpoResultSummary">Resultado de Funções do Corpo aguardando definição.</div>
            </div>
            <div class="jc-field">
              <div class="jc-field-title">Perícia médica trouxe elementos para requalificar Atividades?</div>
              <div class="jc-segmented" id="jcHasAtivMedButtons">
                <button class="jc-seg-btn" data-value="sim">Sim</button>
                <button class="jc-seg-btn" data-value="nao">Não</button>
              </div>
              <p class="jc-field-helper">Se “Sim”, escolha o modo de requalificação abaixo.</p>
            </div>
            <div class="jc-field hidden" id="jcAtivMedWrap">
              <div class="jc-field-title">Modo de requalificação de Atividades (médico judicial)</div>
              <div class="jc-segmented" id="jcAtivModeButtons">
                <button class="jc-seg-btn" data-value="simples">Simples</button>
                <button class="jc-seg-btn" data-value="completa">Completa (d1–d9)</button>
              </div>
              <p class="jc-field-helper">No modo simples, informe apenas o qualificador final com justificativa. No modo completo, informe d1–d9 e o sistema calcula o final pela fórmula normativa.</p>
              <div class="jc-ativ-mode-block hidden" id="jcAtivModeSimpleWrap">
                <div class="jc-field-title">Atividades e Participação (final, modo simples)</div>
                <div class="jc-q-buttons" id="jcAtivMedSimpleButtons">
                  <button class="jc-q-btn" data-value="0">N</button>
                  <button class="jc-q-btn" data-value="1">L</button>
                  <button class="jc-q-btn" data-value="2">M</button>
                  <button class="jc-q-btn" data-value="3">G</button>
                  <button class="jc-q-btn" data-value="4">C</button>
                </div>
                <label class="jc-field-title jc-field-title-margin" for="jcAtivMedJustification">Justificativa médica (obrigatória no modo simples)</label>
                <textarea id="jcAtivMedJustification" class="jc-mini-textarea" placeholder="Descreva, de forma objetiva, o fundamento técnico para o qualificador final de Atividades."></textarea>
              </div>
              <div class="jc-ativ-mode-block hidden" id="jcAtivModeCompleteWrap">
                <div class="jc-field-title">Domínios d1–d9 (modo completo)</div>
                <p class="jc-field-helper">Preencha todos os domínios para calcular automaticamente o qualificador final de Atividades.</p>
                <div class="jc-complete-grid">
                  <div class="jc-complete-item">
                    <div class="jc-field-title">d1 · Aprendizagem</div>
                    <div class="jc-q-buttons" id="jcAtivD1Buttons">
                      <button class="jc-q-btn" data-value="0">N</button>
                      <button class="jc-q-btn" data-value="1">L</button>
                      <button class="jc-q-btn" data-value="2">M</button>
                      <button class="jc-q-btn" data-value="3">G</button>
                      <button class="jc-q-btn" data-value="4">C</button>
                    </div>
                  </div>
                  <div class="jc-complete-item">
                    <div class="jc-field-title">d2 · Tarefas Gerais</div>
                    <div class="jc-q-buttons" id="jcAtivD2Buttons">
                      <button class="jc-q-btn" data-value="0">N</button>
                      <button class="jc-q-btn" data-value="1">L</button>
                      <button class="jc-q-btn" data-value="2">M</button>
                      <button class="jc-q-btn" data-value="3">G</button>
                      <button class="jc-q-btn" data-value="4">C</button>
                    </div>
                  </div>
                  <div class="jc-complete-item">
                    <div class="jc-field-title">d3 · Comunicação</div>
                    <div class="jc-q-buttons" id="jcAtivD3Buttons">
                      <button class="jc-q-btn" data-value="0">N</button>
                      <button class="jc-q-btn" data-value="1">L</button>
                      <button class="jc-q-btn" data-value="2">M</button>
                      <button class="jc-q-btn" data-value="3">G</button>
                      <button class="jc-q-btn" data-value="4">C</button>
                    </div>
                  </div>
                  <div class="jc-complete-item">
                    <div class="jc-field-title">d4 · Mobilidade</div>
                    <div class="jc-q-buttons" id="jcAtivD4Buttons">
                      <button class="jc-q-btn" data-value="0">N</button>
                      <button class="jc-q-btn" data-value="1">L</button>
                      <button class="jc-q-btn" data-value="2">M</button>
                      <button class="jc-q-btn" data-value="3">G</button>
                      <button class="jc-q-btn" data-value="4">C</button>
                    </div>
                  </div>
                  <div class="jc-complete-item">
                    <div class="jc-field-title">d5 · Cuidado Pessoal</div>
                    <div class="jc-q-buttons" id="jcAtivD5Buttons">
                      <button class="jc-q-btn" data-value="0">N</button>
                      <button class="jc-q-btn" data-value="1">L</button>
                      <button class="jc-q-btn" data-value="2">M</button>
                      <button class="jc-q-btn" data-value="3">G</button>
                      <button class="jc-q-btn" data-value="4">C</button>
                    </div>
                  </div>
                  <div class="jc-complete-item">
                    <div class="jc-field-title">d6 · Vida Doméstica</div>
                    <div class="jc-q-buttons" id="jcAtivD6Buttons">
                      <button class="jc-q-btn" data-value="0">N</button>
                      <button class="jc-q-btn" data-value="1">L</button>
                      <button class="jc-q-btn" data-value="2">M</button>
                      <button class="jc-q-btn" data-value="3">G</button>
                      <button class="jc-q-btn" data-value="4">C</button>
                    </div>
                  </div>
                  <div class="jc-complete-item">
                    <div class="jc-field-title">d7 · Relações Interpessoais</div>
                    <div class="jc-q-buttons" id="jcAtivD7Buttons">
                      <button class="jc-q-btn" data-value="0">N</button>
                      <button class="jc-q-btn" data-value="1">L</button>
                      <button class="jc-q-btn" data-value="2">M</button>
                      <button class="jc-q-btn" data-value="3">G</button>
                      <button class="jc-q-btn" data-value="4">C</button>
                    </div>
                  </div>
                  <div class="jc-complete-item">
                    <div class="jc-field-title">d8 · Áreas Principais da Vida</div>
                    <div class="jc-q-buttons" id="jcAtivD8Buttons">
                      <button class="jc-q-btn" data-value="0">N</button>
                      <button class="jc-q-btn" data-value="1">L</button>
                      <button class="jc-q-btn" data-value="2">M</button>
                      <button class="jc-q-btn" data-value="3">G</button>
                      <button class="jc-q-btn" data-value="4">C</button>
                    </div>
                  </div>
                  <div class="jc-complete-item">
                    <div class="jc-field-title">d9 · Vida Comunitária</div>
                    <div class="jc-q-buttons" id="jcAtivD9Buttons">
                      <button class="jc-q-btn" data-value="0">N</button>
                      <button class="jc-q-btn" data-value="1">L</button>
                      <button class="jc-q-btn" data-value="2">M</button>
                      <button class="jc-q-btn" data-value="3">G</button>
                      <button class="jc-q-btn" data-value="4">C</button>
                    </div>
                  </div>
                </div>
                <div class="jc-inline-note" id="jcAtivComputedSummary">Preencha d1–d9 para calcular o qualificador final de Atividades.</div>
              </div>
            </div>
          </div>
        </section>

        <section class="jc-step" id="stepTriagem">
          <div class="jc-step-header">
            <div class="jc-step-title"><span class="jc-step-index">3</span>Triagem probatória</div>
            <span class="jc-step-state pending" id="jcTriagemState">Pendente</span>
          </div>
          <p class="jc-step-note">O que isso mostra: resultado dos Testes A/B e a razão objetiva para dispensar ou exigir avaliação social.</p>
          <div class="jc-status-badge pending" id="jcStatusBadge">Preencha as etapas 1 e 2 para liberar a conclusão probatória.</div>
          <div class="jc-trace" id="jcTrace"></div>
        </section>

        <section class="jc-step" id="stepTexto">
          <div class="jc-step-header">
            <div class="jc-step-title"><span class="jc-step-index">4</span>Texto para decisão</div>
            <span class="jc-step-state blocked" id="jcTextoState">Aguardando triagem</span>
          </div>
          <p class="jc-step-helper">Gere texto padronizado com a trilha de raciocínio da triagem para colar na decisão.</p>
          <p class="jc-step-note">O que fazer: gere e copie a minuta apenas após a triagem estar concluída.</p>
          <div class="standard-text-actions">
            <span class="copy-feedback" id="copyFeedbackControle"></span>
            <button class="btn btn-outline" id="btnGerarControleTexto"><svg class="ui-icon sm" aria-hidden="true"><use href="#i-document"></use></svg>Gerar texto</button>
            <button class="btn btn-gold" id="btnGerarCopiarControleTexto"><svg class="ui-icon sm" aria-hidden="true"><use href="#i-clipboard"></use></svg>Gerar e copiar texto da decisão</button>
            <button class="btn btn-outline" id="btnCopiarControleTexto"><svg class="ui-icon sm" aria-hidden="true"><use href="#i-clipboard"></use></svg>Somente copiar</button>
            <button class="btn btn-red" id="btnLimparControleJudicial"><svg class="ui-icon sm" aria-hidden="true"><use href="#i-close"></use></svg>Limpar controle judicial</button>
          </div>
          <textarea id="textoControleJudicial" class="jc-textarea" readonly></textarea>
        </section>
      </div>
    </div>

    <footer>
      <p>Base normativa: Portaria Conjunta MDS/INSS nº 2/2015 (Anexo IV) · Portaria MDS/INSS nº 34/2025 (Art. 13, §7º)
      </p>
      <p>Resolução CNJ nº 630/2025 (Sisperjud) · 2ª Turma Recursal — SJRJ | Gabinete 3</p>
    </footer>
  </div>

  <script>
    // ============ DOMAIN DEFINITIONS ============
    const Q_LABELS = ['N', 'L', 'M', 'G', 'C'];
    const Q_NAMES = ['Nenhuma', 'Leve', 'Moderada', 'Grave', 'Completa'];
    const Q_FULL = {
      amb: ['Nenhuma Barreira', 'Barreira Leve', 'Barreira Moderada', 'Barreira Grave', 'Barreira Completa'],
      corpo: ['Nenhuma Alteração', 'Alteração Leve', 'Alteração Moderada', 'Alteração Grave', 'Alteração Completa'],
      ativ: ['Nenhuma Dificuldade', 'Dificuldade Leve', 'Dificuldade Moderada', 'Dificuldade Grave', 'Dificuldade Completa']
    };

    const DOM_AMB = [
      { id: 'e1', name: 'Produtos e Tecnologia' }, { id: 'e2', name: 'Condições de Habitabilidade' },
      { id: 'e3', name: 'Apoio e Relacionamentos' }, { id: 'e4', name: 'Atitudes' },
      { id: 'e5', name: 'Serviços, Sistemas e Políticas' }
    ];
    const DOM_CORPO = [
      { id: 'b1', name: 'Funções Mentais' }, { id: 'b2', name: 'Visão' }, { id: 'b3', name: 'Audição' },
      { id: 'b4', name: 'Dor e Sensações' }, { id: 'b5', name: 'Voz e Fala' },
      { id: 'b6', name: 'Cardiovascular / Respiratório' }, { id: 'b7', name: 'Digestivo / Metabólico' },
      { id: 'b8', name: 'Neuromusculoesquelético' }
    ];
    const DOM_ATIV_M = [
      { id: 'd1', name: 'Aprendizagem', cut: 6 }, { id: 'd2', name: 'Tarefas Gerais', cut: 6 },
      { id: 'd3', name: 'Comunicação', cut: 12 }, { id: 'd4', name: 'Mobilidade', cut: 6 },
      { id: 'd5', name: 'Cuidado Pessoal', cut: 36 }
    ];
    const DOM_ATIV_S = [
      { id: 'd6', name: 'Vida Doméstica', cut: 84 }, { id: 'd7', name: 'Relações Interpessoais', cut: 12 },
      { id: 'd8', name: 'Áreas Principais da Vida', cut: 6 }, { id: 'd9', name: 'Vida Comunitária', cut: 36 }
    ];

    // ============ STATE ============
    const state = {};
    [...DOM_AMB, ...DOM_CORPO, ...DOM_ATIV_M, ...DOM_ATIV_S].forEach(d => state[d.id] = 0);
    const domainNameById = [...DOM_AMB, ...DOM_CORPO, ...DOM_ATIV_M, ...DOM_ATIV_S]
      .reduce((acc, d) => { acc[d.id] = d.name; return acc; }, {});
    const CHILD_AGE_LIMIT_MONTHS = 192;
    const JC_ATIV_RECLASS_DOMAINS = [...DOM_ATIV_M, ...DOM_ATIV_S].map(d => d.id);
    const JC_CORPO_RECLASS_DOMAINS = DOM_CORPO.map(d => d.id);
    const JC_CORPO_REASON_LABELS = {
      estruturas: 'Estruturas do corpo mais graves (não reconhecidas pelo INSS)',
      prognostico: 'Prognóstico desfavorável (não reconhecido pelo INSS)',
      dominio_max: 'Domínio administrativo b1–b8 mais grave',
      rebaixamento: 'Rebaixamento por prova superveniente'
    };
    let progDesfav = false, estrMaior = false, impedimento = false, crianca = false, idadeMeses = CHILD_AGE_LIMIT_MONTHS, idadeValor = 15, idadeUnidade = 'anos';
    let savedINSS = null;
    let uiMode = 'controle';

    function createEmptyAdminCorpoRecognition() {
      return { estruturasReconhecidas: null, prognosticoReconhecido: null };
    }

    function createEmptyCorpoReclassDomains() {
      return JC_CORPO_RECLASS_DOMAINS.reduce((acc, id) => {
        acc[id] = null;
        return acc;
      }, {});
    }

    function createEmptyAtivReclassDomains() {
      return JC_ATIV_RECLASS_DOMAINS.reduce((acc, id) => {
        acc[id] = null;
        return acc;
      }, {});
    }

    function createEmptyJudicialMed() {
      return {
        impedimentoLP: null,
        corpoJud: null,
        corpoKeepAdmin: null,
        corpoChangeReason: null,
        corpoAdminDomains: createEmptyCorpoReclassDomains(),
        corpoJudManual: null,
        corpoAlertReductionConfirmed: false,
        hasAtivMed: null,
        ativMode: null,
        ativMedSimple: null,
        ativMedJustification: '',
        ativMedDomains: createEmptyAtivReclassDomains(),
        ativMedComputed: null
      };
    }

    const judicialControl = {
      adminDraft: {
        amb: null,
        ativ: null,
        corpo: null,
        corpoReconhecimentoInss: createEmptyAdminCorpoRecognition()
      },
      adminBase: null,
      med: createEmptyJudicialMed(),
      triage: { ready: false, status: 'pending', testeA: null, testeB: null, reason: '' },
      ui: { activeStep: 1, progressPct: 25, blockReason: '' }
    };
    let currentAmbTab = 0;
    const childDomainBackup = {};
    const userFilledDomains = new Set();

    // ============ CALCULATION ============
    function pctToQ(pct) {
      if (pct < 0) pct = 0;
      if (pct <= 4) return 0; if (pct <= 24) return 1; if (pct <= 49) return 2; if (pct <= 95) return 3; return 4;
    }
    function calcAmbiente() {
      const s = DOM_AMB.reduce((a, d) => a + state[d.id], 0);
      const pct = Math.max(0, (s * 5) - 0.1);
      return { sum: s, pct: +pct.toFixed(1), q: pctToQ(pct) };
    }
    function calcAtividades() {
      const s = [...DOM_ATIV_M, ...DOM_ATIV_S].reduce((a, d) => a + state[d.id], 0);
      const pct = Math.max(0, (s * 2.77777777777778) - 0.1);
      return { sum: s, pct: +pct.toFixed(1), q: pctToQ(pct) };
    }
    function calcCorpo() {
      let mx = DOM_CORPO.reduce((a, d) => Math.max(a, state[d.id]), 0);
      const base = mx;
      if ((progDesfav || estrMaior) && mx < 4) mx++;
      return { max: base, final: mx, majorado: mx > base, q: mx };
    }
    function tabelaConclusiva(amb, ativ, corpo) {
      if (corpo <= 1) return false;
      if (ativ <= 1) return false;
      if (corpo >= 3) return true;
      if (ativ >= 3) return true;
      return amb >= 3;
    }
    function getDecisionReason(ambQ, ativQ, corpoQ, yes) {
      if (!yes) {
        if (corpoQ <= 1) return `Funções do Corpo = ${Q_LABELS[corpoQ]} (${Q_NAMES[corpoQ]}) — exige-se ≥ Moderada`;
        if (ativQ <= 1) return `Atividades e Participação = ${Q_LABELS[ativQ]} (${Q_NAMES[ativQ]}) — exige-se ≥ Moderada`;
        return `Combinação M-M com Ambiente ${Q_LABELS[ambQ]} — exige-se Ambiente ≥ Grave`;
      }
      if (corpoQ >= 3 && ativQ >= 2) return `Funções ${Q_LABELS[corpoQ]} + Atividades ${Q_LABELS[ativQ]} — deferimento independente do Ambiente`;
      if (ativQ >= 3 && corpoQ >= 2) return `Atividades ${Q_LABELS[ativQ]} + Funções ${Q_LABELS[corpoQ]} — deferimento independente do Ambiente`;
      return `Corpo M + Atividades M + Ambiente ${Q_LABELS[ambQ]} (≥ G) — combinação deferida`;
    }
    function iconMarkup(name, cls = 'ui-icon') {
      return `<svg class="${cls}" aria-hidden="true"><use href="#i-${name}"></use></svg>`;
    }
    function setDecisionIcon(name) {
      document.getElementById('decIcon').innerHTML = iconMarkup(name, 'ui-icon lg');
    }
    function getItemNumber(amb, ativ, corpo) {
      // Items ordered: corpo C→N, for each corpo: ativ C→N, for each ativ: amb C→N
      const corpoOrder = [4, 3, 2, 1, 0], ativOrder = [4, 3, 2, 1, 0], ambOrder = [4, 3, 2, 1, 0];
      let n = 0;
      for (const c of corpoOrder) for (const a of ativOrder) for (const e of ambOrder) {
        n++; if (c === corpo && a === ativ && e === amb) return n;
      }
      return n;
    }

    function escapeHtml(str = '') {
      return String(str).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
    }

    function computeAtivFromDomains(domains) {
      if (!domains) return null;
      const missing = JC_ATIV_RECLASS_DOMAINS.some(id => domains[id] == null);
      if (missing) return null;
      const sum = JC_ATIV_RECLASS_DOMAINS.reduce((acc, id) => acc + domains[id], 0);
      const pctRaw = Math.max(0, (sum * 2.77777777777778) - 0.1);
      return { sum, pct: +pctRaw.toFixed(1), q: pctToQ(pctRaw) };
    }

    function updateAtivMedComputed() {
      const m = judicialControl.med;
      if (m.ativMode !== 'completa' || m.hasAtivMed !== true) {
        m.ativMedComputed = null;
        return null;
      }
      m.ativMedComputed = computeAtivFromDomains(m.ativMedDomains);
      return m.ativMedComputed;
    }

    function resolveAtivMed() {
      const m = judicialControl.med;
      if (m.hasAtivMed !== true) return null;
      if (m.ativMode === 'simples') return m.ativMedSimple;
      if (m.ativMode === 'completa') {
        const computed = m.ativMedComputed || computeAtivFromDomains(m.ativMedDomains);
        return computed ? computed.q : null;
      }
      return null;
    }

    function isCorpoReasonBlocked(reason) {
      const base = judicialControl.adminBase;
      if (!base || !reason) return false;
      if (reason === 'estruturas') return base.corpoReconhecimentoInss.estruturasReconhecidas === true;
      if (reason === 'prognostico') return base.corpoReconhecimentoInss.prognosticoReconhecido === true;
      return false;
    }

    function getCorpoReasonBlockedMessage(reason) {
      if (reason === 'estruturas') return 'Motivo indisponível: a base administrativa já registra reconhecimento de estruturas do corpo mais graves pelo INSS.';
      if (reason === 'prognostico') return 'Motivo indisponível: a base administrativa já registra reconhecimento de prognóstico desfavorável pelo INSS.';
      return 'Motivo indisponível para esta base administrativa.';
    }

    function resolveCorpoJudFlow() {
      const base = judicialControl.adminBase;
      const m = judicialControl.med;
      if (!base) return { ready: false, q: null, reason: 'Fixe a base administrativa antes da requalificação de Funções do Corpo.', mode: 'pending' };
      if (m.corpoKeepAdmin == null) return { ready: false, q: null, reason: 'Em Funções do Corpo, informe se o qualificador administrativo será mantido.', mode: 'pending' };

      if (m.corpoKeepAdmin) {
        return {
          ready: true,
          q: base.corpo,
          mode: 'mantido',
          reason: 'Qualificador administrativo de Funções do Corpo mantido na fase judicial.',
          decreased: false
        };
      }

      if (!m.corpoChangeReason) {
        return { ready: false, q: null, reason: 'Selecione o motivo da alteração de Funções do Corpo.', mode: 'pending' };
      }

      if (isCorpoReasonBlocked(m.corpoChangeReason)) {
        return { ready: false, q: null, reason: getCorpoReasonBlockedMessage(m.corpoChangeReason), mode: 'blocked' };
      }

      if (m.corpoChangeReason === 'estruturas') {
        const q = Math.min(base.corpo + 1, 4);
        return {
          ready: true,
          q,
          mode: 'estruturas',
          reason: 'Regra aplicada: majoração de +1 por estruturas do corpo mais graves não reconhecidas na fase administrativa.',
          decreased: q < base.corpo
        };
      }

      if (m.corpoChangeReason === 'prognostico') {
        const q = Math.min(base.corpo + 1, 4);
        return {
          ready: true,
          q,
          mode: 'prognostico',
          reason: 'Regra aplicada: majoração de +1 por prognóstico desfavorável não reconhecido na fase administrativa.',
          decreased: q < base.corpo
        };
      }

      if (m.corpoChangeReason === 'dominio_max') {
        const filledDomains = JC_CORPO_RECLASS_DOMAINS.filter(id => m.corpoAdminDomains[id] != null);
        if (!filledDomains.length) {
          return { ready: false, q: null, reason: 'No motivo "Domínio administrativo b1–b8 mais grave", informe ao menos um domínio b1 a b8.', mode: 'pending' };
        }
        const q = filledDomains.reduce((acc, id) => Math.max(acc, m.corpoAdminDomains[id]), 0);
        return {
          ready: true,
          q,
          mode: 'dominio_max',
          reason: 'Regra aplicada: para Funções do Corpo prevalece o domínio administrativo mais grave entre os domínios informados (b1–b8).',
          domainsText: filledDomains.map(id => `${id.toUpperCase()}=${Q_LABELS[m.corpoAdminDomains[id]]}`).join(' · '),
          decreased: q < base.corpo
        };
      }

      if (m.corpoChangeReason === 'rebaixamento') {
        if (m.corpoJudManual == null) {
          return { ready: false, q: null, reason: 'No motivo "Rebaixamento por prova superveniente", selecione o qualificador judicial de Funções do Corpo.', mode: 'pending' };
        }
        const decreased = m.corpoJudManual < base.corpo;
        if (decreased && !m.corpoAlertReductionConfirmed) {
          return {
            ready: false,
            q: m.corpoJudManual,
            reason: 'Confirme a redução do qualificador de Funções do Corpo para prosseguir.',
            mode: 'rebaixamento',
            decreased: true,
            needsReductionConfirm: true
          };
        }
        return {
          ready: true,
          q: m.corpoJudManual,
          mode: 'rebaixamento',
          reason: 'Regra aplicada: rebaixamento por prova superveniente, com fixação manual do qualificador judicial.',
          decreased
        };
      }

      return { ready: false, q: null, reason: 'Motivo de alteração de Funções do Corpo inválido.', mode: 'invalid' };
    }

    function getCorpoFlowTraceLine(corpoFlow) {
      const base = judicialControl.adminBase;
      const m = judicialControl.med;
      if (!base) return `<div class="jc-trace-line"><strong>Funções do Corpo</strong>: base administrativa não fixada.</div>`;
      if (m.corpoKeepAdmin == null) return `<div class="jc-trace-line"><strong>Funções do Corpo</strong>: aguardando decisão sobre manter ou alterar o qualificador administrativo.</div>`;
      if (m.corpoKeepAdmin) return `<div class="jc-trace-line"><strong>Funções do Corpo</strong>: qualificador administrativo mantido em <strong>${Q_LABELS[base.corpo]}</strong>.</div>`;
      if (!m.corpoChangeReason) return `<div class="jc-trace-line"><strong>Funções do Corpo</strong>: aguardando seleção do motivo da alteração.</div>`;
      if (!corpoFlow.ready && corpoFlow.q == null) return `<div class="jc-trace-line"><strong>Funções do Corpo</strong>: ${corpoFlow.reason}</div>`;
      const motivo = JC_CORPO_REASON_LABELS[m.corpoChangeReason] || 'Motivo não identificado';
      const details = corpoFlow.mode === 'dominio_max' && corpoFlow.domainsText ? ` Domínios: ${corpoFlow.domainsText}.` : '';
      const pendencia = !corpoFlow.ready ? ` Pendência: ${corpoFlow.reason}` : '';
      return `<div class="jc-trace-line"><strong>Funções do Corpo</strong>: motivo "${motivo}". ${corpoFlow.reason} Resultado judicial: <strong>${Q_LABELS[corpoFlow.q]}</strong>.${details}${pendencia}</div>`;
    }

    // ============ DOM BUILDERS ============
    function buildDomainRows(container, domains) {
      const scale = document.createElement('div');
      scale.className = 'note-scale-row';
      scale.innerHTML = `<div class="note-scale-spacer"></div>
      <div class="note-scale">${Q_LABELS.map(l => `<span>${l}</span>`).join('')}</div>`;
      container.appendChild(scale);
      domains.forEach(d => {
        const row = document.createElement('div');
        row.className = 'domain-row';
        row.innerHTML = `<div class="domain-label"><span class="domain-code">${d.id}</span> <span class="domain-name">${d.name}</span></div>
      <div class="note-buttons" data-domain="${d.id}">${[0, 1, 2, 3, 4].map(v => `<button class="note-btn${v === 0 ? ' active' : ''}" data-value="${v}">${v}</button>`).join('')}</div>`;
        container.appendChild(row);
      });
    }
    function buildTabelaGrid() {
      const g = document.getElementById('tGrid');
      g.innerHTML = '';
      // Corner
      g.innerHTML += '<div class="tc corner"></div>';
      // Header row (Atividades)
      Q_LABELS.forEach(l => g.innerHTML += `<div class="tc header">${l}</div>`);
      // Rows (Corpo)
      for (let c = 0; c < 5; c++) {
        g.innerHTML += `<div class="tc row-header">${Q_LABELS[c]}</div>`;
        for (let a = 0; a < 5; a++) {
          const yes = tabelaConclusiva(currentAmbTab, a, c);
          g.innerHTML += `<div class="tc ${yes ? 'yes' : 'no'}" data-c="${c}" data-a="${a}">${yes ? 'Sim' : 'Não'}</div>`;
        }
      }
    }

    // ============ UI UPDATE ============
    function update() {
      const amb = calcAmbiente(), ativ = calcAtividades(), corpo = calcCorpo();
      // Panel Ambiente
      document.getElementById('fAmb').innerHTML = `(<span class="val">${amb.sum}</span> × 5) − 0,1 = <span class="val">${amb.pct}%</span>`;
      const barA = document.getElementById('barAmb');
      barA.style.width = Math.min(100, amb.pct) + '%';
      barA.style.background = `var(--q${Q_LABELS[amb.q]})`;
      setQBadge('qAmb', amb.q);
      document.getElementById('nameAmb').textContent = Q_FULL.amb[amb.q];

      // Panel Corpo
      const mInfo = corpo.majorado ? ` → <span class="val">${corpo.final}</span> (majoração +1)` : '';
      document.getElementById('fCorpo').innerHTML = `Máximo dos domínios: <span class="val">${corpo.max}</span>${mInfo}`;
      setQBadge('qCorpo', corpo.q);
      document.getElementById('nameCorpo').textContent = Q_FULL.corpo[corpo.q];

      // Panel Atividades
      document.getElementById('fAtiv').innerHTML = `(<span class="val">${ativ.sum}</span> × 2,778) − 0,1 = <span class="val">${ativ.pct}%</span>`;
      const barB = document.getElementById('barAtiv');
      barB.style.width = Math.min(100, ativ.pct) + '%';
      barB.style.background = `var(--q${Q_LABELS[ativ.q]})`;
      setQBadge('qAtiv', ativ.q);
      document.getElementById('nameAtiv').textContent = Q_FULL.ativ[ativ.q];

      // Result qualifiers
      setQBadge('rAmb', amb.q); setQBadge('rAtiv', ativ.q); setQBadge('rCorpo', corpo.q);
      document.getElementById('dAmb').textContent = Q_NAMES[amb.q];
      document.getElementById('dAtiv').textContent = Q_NAMES[ativ.q];
      document.getElementById('dCorpo').textContent = Q_NAMES[corpo.q];

      // Auto-select amb tab
      currentAmbTab = amb.q;
      document.querySelectorAll('.amb-tab').forEach(t => { t.classList.toggle('active', +t.dataset.a === amb.q) });
      buildTabelaGrid();
      highlightActiveCell(ativ.q, corpo.q);

      // Decision
      const dec = document.getElementById('decision');
      const item = getItemNumber(amb.q, ativ.q, corpo.q);
      if (impedimento) {
        dec.className = 'decision impedimento';
        setDecisionIcon('alert');
        document.getElementById('decLabel').textContent = 'INDEFERIDO';
        document.getElementById('decReason').textContent = 'Impedimento inferior a 2 anos — requisito não satisfeito';
        document.getElementById('decItem').textContent = 'Art. 20, §§ 2º e 10, Lei 8.742/93';
      } else {
        const yes = tabelaConclusiva(amb.q, ativ.q, corpo.q);
        dec.className = 'decision ' + (yes ? 'deferido' : 'indeferido');
        setDecisionIcon(yes ? 'check-circle' : 'x-circle');
        document.getElementById('decLabel').textContent = yes ? 'DEFERIDO' : 'INDEFERIDO';
        const reason = getDecisionReason(amb.q, ativ.q, corpo.q, yes);
        document.getElementById('decReason').textContent = reason;
        document.getElementById('decItem').textContent = `Item ${item} da Tabela Conclusiva`;
      }
      dec.classList.add('pop');
      setTimeout(() => dec.classList.remove('pop'), 300);

      // Comparison
      if (savedINSS) updateComparison(amb, ativ, corpo);
      if (!document.getElementById('textoSection').classList.contains('hidden')) renderStandardText(amb, ativ, corpo);
      if (uiMode === 'controle') updateAdminAutofillShortcut();
    }

    function setQBadge(id, q) {
      const el = document.getElementById(id);
      el.textContent = Q_LABELS[q]; el.dataset.q = Q_LABELS[q];
    }
    function highlightActiveCell(ativQ, corpoQ) {
      document.querySelectorAll('.tc.active-cell').forEach(c => c.classList.remove('active-cell'));
      document.querySelectorAll('.tc[data-c]').forEach(c => {
        if (+c.dataset.c === corpoQ && +c.dataset.a === ativQ) c.classList.add('active-cell');
      });
    }

    // ============ EVENT HANDLERS ============
    document.addEventListener('click', e => {
      const btn = e.target.closest('.note-btn');
      if (!btn || btn.classList.contains('locked')) return;
      const group = btn.parentElement;
      const domain = group.dataset.domain;
      const val = +btn.dataset.value;
      group.querySelectorAll('.note-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state[domain] = val;
      userFilledDomains.add(domain);
      update();
    });

    document.getElementById('toggleProg').addEventListener('change', e => { progDesfav = e.target.checked; update() });
    document.getElementById('toggleEstr').addEventListener('change', e => { estrMaior = e.target.checked; update() });
    document.getElementById('toggleImpedimento').addEventListener('change', e => { impedimento = e.target.checked; update() });

    // Dark mode
    document.getElementById('toggleDark').addEventListener('change', e => {
      document.documentElement.dataset.theme = e.target.checked ? 'dark' : '';
    });

    // Children mode by explicit selection
    function getAgeBounds(unit) {
      return unit === 'anos' ? { min: 0, max: 15 } : { min: 0, max: 191 };
    }
    function valueToMonths(value, unit) {
      return unit === 'anos' ? value * 12 : value;
    }
    function syncChildModeByControls() {
      const wrap = document.getElementById('idadeWrap');
      const input = document.getElementById('inputIdade');
      const unitSel = document.getElementById('inputIdadeUnidade');
      const faixa = document.getElementById('faixaEtaria');

      wrap.classList.toggle('hidden', !crianca);
      idadeUnidade = unitSel.value;
      const bounds = getAgeBounds(idadeUnidade);
      input.min = bounds.min;
      input.max = bounds.max;
      input.step = 1;

      if (!crianca) {
        idadeMeses = CHILD_AGE_LIMIT_MONTHS;
        faixa.textContent = 'Padrão: 16 anos ou mais';
        document.getElementById('childAutoSummary').classList.add('hidden');
        return;
      }

      idadeValor = Math.max(bounds.min, Math.min(bounds.max, Math.floor(+input.value || 0)));
      input.value = idadeValor;
      idadeMeses = valueToMonths(idadeValor, idadeUnidade);
      faixa.textContent = `${idadeMeses} meses`;
    }
    document.getElementById('toggleMenor16').addEventListener('change', e => {
      crianca = e.target.checked;
      syncChildModeByControls();
      applyChildRules();
      update();
    });
    document.getElementById('inputIdade').addEventListener('input', () => {
      syncChildModeByControls();
      applyChildRules();
      update();
    });
    document.getElementById('inputIdadeUnidade').addEventListener('change', e => {
      const input = document.getElementById('inputIdade');
      const currentValue = Math.max(0, Math.floor(+input.value || 0));
      const currentMonths = valueToMonths(currentValue, idadeUnidade);
      const nextUnit = e.target.value;
      input.value = nextUnit === 'anos' ? Math.floor(currentMonths / 12) : currentMonths;
      syncChildModeByControls();
      applyChildRules();
      update();
    });
    function applyChildRules() {
      [...DOM_ATIV_M, ...DOM_ATIV_S].forEach(d => {
        const btns = document.querySelectorAll(`[data-domain="${d.id}"] .note-btn`);
        if (crianca && idadeMeses < d.cut) {
          if (!(d.id in childDomainBackup)) childDomainBackup[d.id] = state[d.id];
          state[d.id] = 4;
          btns.forEach(b => {
            b.classList.toggle('active', +b.dataset.value === 4);
            b.classList.add('locked');
          });
        } else {
          if (d.id in childDomainBackup) {
            state[d.id] = childDomainBackup[d.id];
            delete childDomainBackup[d.id];
          }
          btns.forEach(b => {
            b.classList.remove('locked');
            b.classList.toggle('active', +b.dataset.value === state[d.id]);
          });
        }
      });
      updateChildAutoSummary();
    }

    // Amb tabs
    document.querySelectorAll('.amb-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        currentAmbTab = +tab.dataset.a;
        document.querySelectorAll('.amb-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        buildTabelaGrid();
        const ativ = calcAtividades(), corpo = calcCorpo();
        highlightActiveCell(ativ.q, corpo.q);
      });
    });

    // Padrão Médio Social
    document.getElementById('btnPadrao').addEventListener('click', () => {
      const padrao = { e1: 2, e2: 2, e3: 2, e4: 1, e5: 2, d6: 3, d7: 2, d8: 3, d9: 3 };
      const padraoEntries = Object.entries(padrao);
      const overwriteFilled = document.getElementById('togglePadraoOverwrite').checked;
      let skippedByAgeCut = 0;
      const eligibleEntries = padraoEntries.filter(([id]) => {
        if (crianca) {
          const d = [...DOM_ATIV_M, ...DOM_ATIV_S].find(x => x.id === id);
          if (d && idadeMeses < d.cut) { skippedByAgeCut++; return false; }
        }
        return true;
      });
      const manuallyFilledEligible = eligibleEntries.filter(([id]) => userFilledDomains.has(id));
      const entriesToApply = overwriteFilled
        ? eligibleEntries
        : eligibleEntries.filter(([id]) => !userFilledDomains.has(id));

      if (!eligibleEntries.length) {
        alert('Padrão Médio Social não aplicado: nenhum domínio está elegível em razão dos pontos de corte etários.');
        return;
      }

      if (!entriesToApply.length) {
        alert('Padrão Médio Social não aplicado: todos os domínios elegíveis já foram preenchidos manualmente e a sobrescrita está desativada.');
        return;
      }

      if (!overwriteFilled && manuallyFilledEligible.length > 0) {
        const appliedList = entriesToApply.map(([id]) => `${id.toUpperCase()} (${domainNameById[id]})`).join(', ');
        const confirmMessage = [
          'Foram encontrados domínios do Padrão Médio Social já preenchidos manualmente.',
          '',
          'Como a opção "Sobrescrever domínios preenchidos" está desativada, esses domínios serão preservados.',
          `Serão atualizados ${entriesToApply.length} domínio(s):`,
          appliedList,
          '',
          `Domínios manuais preservados: ${manuallyFilledEligible.length}.`,
          `Domínios não aplicáveis por ponto de corte etário: ${skippedByAgeCut}.`
        ].join('\n');
        if (!window.confirm(confirmMessage)) return;
      }

      entriesToApply.forEach(([id, v]) => {
        state[id] = v;
        const btns = document.querySelectorAll(`[data-domain="${id}"] .note-btn`);
        btns.forEach(b => { b.classList.remove('active'); if (+b.dataset.value === v) b.classList.add('active') });
      });
      update();
    });

    // Clear
    document.getElementById('btnLimpar').addEventListener('click', () => {
      Object.keys(state).forEach(k => state[k] = 0);
      Object.keys(childDomainBackup).forEach(k => delete childDomainBackup[k]);
      userFilledDomains.clear();
      progDesfav = false; estrMaior = false; impedimento = false;
      crianca = false; idadeValor = 15; idadeUnidade = 'anos'; idadeMeses = CHILD_AGE_LIMIT_MONTHS;
      document.getElementById('toggleProg').checked = false;
      document.getElementById('toggleEstr').checked = false;
      document.getElementById('togglePadraoOverwrite').checked = false;
      document.getElementById('toggleImpedimento').checked = false;
      document.getElementById('toggleMenor16').checked = false;
      document.getElementById('inputIdade').value = idadeValor;
      document.getElementById('inputIdadeUnidade').value = idadeUnidade;
      syncChildModeByControls();
      document.querySelectorAll('.note-btn').forEach(b => { b.classList.remove('active', 'locked'); if (+b.dataset.value === 0) b.classList.add('active') });
      applyChildRules();
      update();
    });

    // Save/Comparison + Judicial Control
    function updateComparison(amb, ativ, corpo) {
      if (!savedINSS) return;
      const s = savedINSS;
      document.getElementById('compINSSq').textContent = `Ambiente: ${Q_LABELS[s.amb]} · Atividades: ${Q_LABELS[s.ativ]} · Funções: ${Q_LABELS[s.corpo]}`;
      document.getElementById('compINSSr').innerHTML = `${iconMarkup(s.result ? 'check-circle' : 'x-circle', 'ui-icon sm')} ${s.result ? 'DEFERIDO' : 'INDEFERIDO'}`;
      document.getElementById('compINSSr').className = 'comp-result ' + (s.result ? 'yes' : 'no');
      const curResult = impedimento ? false : tabelaConclusiva(amb.q, ativ.q, corpo.q);
      document.getElementById('compPERq').textContent = `Ambiente: ${Q_LABELS[amb.q]} · Atividades: ${Q_LABELS[ativ.q]} · Funções: ${Q_LABELS[corpo.q]}`;
      document.getElementById('compPERr').innerHTML = `${iconMarkup(curResult ? 'check-circle' : 'x-circle', 'ui-icon sm')} ${curResult ? 'DEFERIDO' : 'INDEFERIDO'}`;
      document.getElementById('compPERr').className = 'comp-result ' + (curResult ? 'yes' : 'no');
      let changes = [];
      if (s.amb !== amb.q) changes.push(`Ambiente: ${Q_LABELS[s.amb]}→${Q_LABELS[amb.q]}`);
      if (s.ativ !== ativ.q) changes.push(`Atividades: ${Q_LABELS[s.ativ]}→${Q_LABELS[ativ.q]}`);
      if (s.corpo !== corpo.q) changes.push(`Funções: ${Q_LABELS[s.corpo]}→${Q_LABELS[corpo.q]}`);
      if (!s.result && curResult) changes.push(`${iconMarkup('swap', 'ui-icon sm')} Resultado REVERTIDO: Indeferido → Deferido`);
      else if (s.result && !curResult) changes.push(`${iconMarkup('swap', 'ui-icon sm')} Resultado REVERTIDO: Deferido → Indeferido`);
      document.getElementById('compChange').innerHTML = changes.length ? changes.join(' · ') : 'Sem alteração no resultado';
    }

    function setStepState(id, state, text) {
      const el = document.getElementById(id);
      el.className = `jc-step-state ${state}`;
      el.textContent = text;
    }

    function setStatusBadge(kind, text) {
      const badge = document.getElementById('jcStatusBadge');
      badge.className = `jc-status-badge ${kind}`;
      badge.innerHTML = text;
    }

    function setWhyBlocked(message = '') {
      const box = document.getElementById('jcWhyBlocked');
      const text = box.querySelector('span');
      if (!message) {
        box.classList.add('hidden');
        text.textContent = '';
        return;
      }
      box.classList.remove('hidden');
      text.textContent = message;
    }

    function syncModeSwitcher() {
      document.querySelectorAll('#modeSwitcher .mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === uiMode);
      });
    }

    function scrollToJudicialControlSection() {
      const section = document.getElementById('judicialControlSection');
      if (!section) return;
      const reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          section.scrollIntoView({ behavior: reduceMotion ? 'auto' : 'smooth', block: 'start' });
        });
      });
    }

    function renderModeVisibility(options = {}) {
      const app = document.querySelector('.app');
      const details = document.getElementById('simuladorDetails');
      app.classList.toggle('mode-simulador', uiMode === 'simulador');
      app.classList.toggle('mode-controle', uiMode === 'controle');
      if (uiMode === 'simulador') {
        details.open = true;
      } else if (!options.preserveAccordionState) {
        details.open = false;
      }
      syncModeSwitcher();
    }

    function setUIMode(mode, options = {}) {
      if (!['simulador', 'controle'].includes(mode)) return;
      if (uiMode === mode) {
        renderModeVisibility({ preserveAccordionState: true, ...options });
        if (mode === 'controle' && options.scrollToJudicial) scrollToJudicialControlSection();
        return;
      }
      uiMode = mode;
      renderModeVisibility(options);
      if (mode === 'controle' && options.scrollToJudicial) scrollToJudicialControlSection();
    }

    function getActiveJudicialStep() {
      const triageReady = judicialControl.triage && judicialControl.triage.ready;
      if (!judicialControl.adminBase) return 1;
      if (!getMedComplete()) return 2;
      if (!triageReady) return 3;
      return 4;
    }

    function getJudicialProgressPct(activeStep) {
      return Math.max(25, Math.min(100, activeStep * 25));
    }

    function renderJudicialProgress() {
      const labels = ['Base administrativa', 'Perícia médica', 'Triagem probatória', 'Texto da decisão'];
      const stepIds = ['stepAdmin', 'stepMed', 'stepTriagem', 'stepTexto'];
      const activeStep = getActiveJudicialStep();
      const progressPct = getJudicialProgressPct(activeStep);
      judicialControl.ui.activeStep = activeStep;
      judicialControl.ui.progressPct = progressPct;

      document.getElementById('jcProgressBar').style.width = `${progressPct}%`;
      document.getElementById('jcProgressPct').textContent = `${progressPct}%`;
      document.getElementById('jcProgressLabel').textContent = `Etapa ${activeStep} de 4 · ${labels[activeStep - 1]}`;
      stepIds.forEach((id, idx) => {
        document.getElementById(id).classList.toggle('active-step', idx + 1 === activeStep);
      });
    }

    function syncQButtonGroup(groupId, value) {
      document.querySelectorAll(`#${groupId} .jc-q-btn`).forEach(btn => {
        btn.classList.toggle('active', value != null && +btn.dataset.value === value);
      });
    }

    function syncSegmentedGroup(groupId, value) {
      document.querySelectorAll(`#${groupId} .jc-seg-btn`).forEach(btn => {
        btn.classList.toggle('active', value != null && btn.dataset.value === value);
      });
    }

    function clearJudicialTextArea() {
      document.getElementById('textoControleJudicial').value = '';
      document.getElementById('copyFeedbackControle').textContent = '';
    }

    function resetAtivMedReclassFields() {
      judicialControl.med.ativMode = null;
      judicialControl.med.ativMedSimple = null;
      judicialControl.med.ativMedJustification = '';
      judicialControl.med.ativMedDomains = createEmptyAtivReclassDomains();
      judicialControl.med.ativMedComputed = null;
    }

    function resetCorpoChangeDetails() {
      judicialControl.med.corpoChangeReason = null;
      judicialControl.med.corpoAdminDomains = createEmptyCorpoReclassDomains();
      judicialControl.med.corpoJudManual = null;
      judicialControl.med.corpoAlertReductionConfirmed = false;
      judicialControl.med.corpoJud = null;
    }

    function resetCorpoReclassFields() {
      judicialControl.med.corpoKeepAdmin = null;
      resetCorpoChangeDetails();
    }

    function getAdminDraftComplete() {
      const d = judicialControl.adminDraft;
      return d.amb != null
        && d.ativ != null
        && d.corpo != null
        && d.corpoReconhecimentoInss.estruturasReconhecidas != null
        && d.corpoReconhecimentoInss.prognosticoReconhecido != null;
    }

    function isAdminDraftDirty() {
      if (!judicialControl.adminBase) return false;
      const d = judicialControl.adminDraft;
      const b = judicialControl.adminBase;
      if (d.amb !== b.amb || d.ativ !== b.ativ || d.corpo !== b.corpo) return true;
      if (d.corpoReconhecimentoInss.estruturasReconhecidas !== b.corpoReconhecimentoInss.estruturasReconhecidas) return true;
      if (d.corpoReconhecimentoInss.prognosticoReconhecido !== b.corpoReconhecimentoInss.prognosticoReconhecido) return true;
      return false;
    }

    function getMedBlockingReason() {
      const m = judicialControl.med;
      if (!judicialControl.adminBase) return 'Fixe a base administrativa para iniciar a etapa médica.';
      if (m.impedimentoLP == null) return 'Informe se há impedimento de longo prazo.';
      const corpoFlow = resolveCorpoJudFlow();
      m.corpoJud = corpoFlow.q;
      if (!corpoFlow.ready || corpoFlow.q == null) return corpoFlow.reason;
      if (m.hasAtivMed == null) return 'Informe se a perícia médica trouxe elementos para requalificar Atividades.';
      if (!m.hasAtivMed) return '';
      if (m.ativMode == null) return 'Selecione o modo de requalificação de Atividades (simples ou completa).';
      if (m.ativMode === 'simples') {
        if (m.ativMedSimple == null) return 'No modo simples, selecione o qualificador final de Atividades.';
        if (!m.ativMedJustification.trim()) return 'No modo simples, informe a justificativa médica de Atividades.';
        return '';
      }
      if (m.ativMode === 'completa') {
        const computed = updateAtivMedComputed();
        if (!computed) return 'No modo completo de Atividades, preencha todos os domínios d1 a d9.';
        return '';
      }
      return 'Modo de requalificação de Atividades inválido.';
    }

    function getMedComplete() {
      return !getMedBlockingReason();
    }

    function getAtivMedTraceLine() {
      const m = judicialControl.med;
      if (m.hasAtivMed !== true) {
        return `<div class="jc-trace-line"><strong>Origem Ativ_med</strong>: não aplicada (sem elementos médicos para requalificar Atividades).</div>`;
      }

      const ativMedResolved = resolveAtivMed();
      if (m.ativMode === 'simples') {
        const raw = m.ativMedJustification.trim();
        const preview = raw.length > 160 ? `${raw.slice(0, 157)}...` : raw;
        return `<div class="jc-trace-line"><strong>Origem Ativ_med</strong>: modo simples, qualificador final <strong>${Q_LABELS[ativMedResolved]}</strong>; justificativa médica: "${escapeHtml(preview)}".</div>`;
      }

      if (m.ativMode === 'completa') {
        const computed = m.ativMedComputed || computeAtivFromDomains(m.ativMedDomains);
        const details = JC_ATIV_RECLASS_DOMAINS.map(id => `${id.toUpperCase()}=${Q_LABELS[m.ativMedDomains[id]]}`).join(' · ');
        if (!computed) {
          return `<div class="jc-trace-line"><strong>Origem Ativ_med</strong>: modo completo d1–d9 ainda incompleto.</div>`;
        }
        return `<div class="jc-trace-line"><strong>Origem Ativ_med</strong>: modo completo (${details}); Σ=${computed.sum}, %=${computed.pct}, Ativ_med=<strong>${Q_LABELS[computed.q]}</strong>.</div>`;
      }

      return `<div class="jc-trace-line"><strong>Origem Ativ_med</strong>: modo não definido.</div>`;
    }

    function computeJudicialTriage() {
      if (!judicialControl.adminBase) {
        return { ready: false, status: 'pending', testeA: null, testeB: null, reason: 'Fixe a base administrativa para iniciar a triagem.' };
      }
      if (isAdminDraftDirty()) {
        return { ready: false, status: 'pending', testeA: null, testeB: null, reason: 'Há alterações no rascunho administrativo. Refixe a base antes da triagem.' };
      }
      const base = judicialControl.adminBase;
      const med = judicialControl.med;
      const medBlock = getMedBlockingReason();
      const corpoFlow = resolveCorpoJudFlow();
      const corpoJud = corpoFlow.q;
      const ativMedResolved = resolveAtivMed();
      if (medBlock) {
        return { ready: false, status: 'pending', testeA: null, testeB: null, reason: medBlock };
      }

      if (med.impedimentoLP === false) {
        return {
          ready: true,
          status: 'dispensa',
          testeA: null,
          testeB: null,
          reason: 'Perícia médica sem impedimento de longo prazo: a avaliação social judicial torna-se dispensável para esta triagem.'
        };
      }

      const testeA = tabelaConclusiva(base.amb, base.ativ, corpoJud);
      if (testeA) {
        const modeLabel = corpoFlow.mode === 'mantido' ? 'com manutenção de Funções do Corpo' : 'com requalificação médica em Funções do Corpo';
        return {
          ready: true,
          status: 'dispensa',
          testeA,
          testeB: null,
          reason: `Teste A positivo ${modeLabel}.`
        };
      }

      let testeB = null;
      if (med.hasAtivMed) {
        testeB = tabelaConclusiva(base.amb, ativMedResolved, corpoJud);
        if (testeB) {
          const modo = med.ativMode === 'completa' ? 'modo completo (fórmula d1–d9)' : 'modo simples';
          return {
            ready: true,
            status: 'dispensa',
            testeA,
            testeB,
            reason: `Teste B positivo com requalificação médica de Atividades no ${modo}.`
          };
        }
      }

      return {
        ready: true,
        status: 'necessaria',
        testeA,
        testeB,
        reason: 'Perícia médica isolada não foi suficiente para resultado positivo; recomenda-se avaliação social judicial com potencial de requalificação de Ambiente e Atividades.'
      };
    }

    function renderAdminFixedSummary() {
      const summary = document.getElementById('jcAdminFixedSummary');
      if (!judicialControl.adminBase) {
        summary.textContent = 'Base administrativa ainda não fixada.';
        return;
      }
      const b = judicialControl.adminBase;
      const reconhecimentoText = ` Reconhecimento INSS em Funções: estruturas mais graves = ${b.corpoReconhecimentoInss.estruturasReconhecidas ? 'Sim' : 'Não'}; prognóstico desfavorável = ${b.corpoReconhecimentoInss.prognosticoReconhecido ? 'Sim' : 'Não'}.`;
      const dirtyText = isAdminDraftDirty() ? ' Existem alterações no rascunho; clique em "Fixar base administrativa" para atualizar a base vigente.' : '';
      summary.textContent = `Base fixada: Ambiente ${Q_LABELS[b.amb]} (${Q_NAMES[b.amb]}), Atividades ${Q_LABELS[b.ativ]} (${Q_NAMES[b.ativ]}), Funções ${Q_LABELS[b.corpo]} (${Q_NAMES[b.corpo]}).${reconhecimentoText}${dirtyText}`;
    }

    function formatQualifierTuple(values) {
      const ambLabel = values.amb == null ? '—' : Q_LABELS[values.amb];
      const ativLabel = values.ativ == null ? '—' : Q_LABELS[values.ativ];
      const corpoLabel = values.corpo == null ? '—' : Q_LABELS[values.corpo];
      return `Amb ${ambLabel} · Ativ ${ativLabel} · Funções ${corpoLabel}`;
    }

    function updateAdminAutofillShortcut() {
      const details = document.getElementById('jcAutoFillDetails');
      const hint = document.getElementById('jcAutoFillHint');
      if (!details || !hint) return;

      const draft = judicialControl.adminDraft;
      const calc = { amb: calcAmbiente().q, ativ: calcAtividades().q, corpo: calcCorpo().q };
      const draftValues = [draft.amb, draft.ativ, draft.corpo];
      const draftComplete = draftValues.every(v => v != null);
      const draftHasAny = draftValues.some(v => v != null);
      const calcHasNonNeutral = calc.amb !== 0 || calc.ativ !== 0 || calc.corpo !== 0;
      const differs = draft.amb !== calc.amb || draft.ativ !== calc.ativ || draft.corpo !== calc.corpo;
      const shouldShow = differs && (calcHasNonNeutral || draftHasAny);

      details.classList.toggle('hidden', !shouldShow);
      if (!shouldShow) {
        details.open = false;
        hint.textContent = '';
        return;
      }

      const calcText = formatQualifierTuple(calc);
      if (!draftComplete) {
        hint.textContent = `Atalho opcional: copiar os qualificadores atuais da Calculadora (${calcText}) para o rascunho desta etapa. Depois, revise e clique em "Fixar base administrativa".`;
        return;
      }

      const draftText = formatQualifierTuple(draft);
      hint.textContent = `Rascunho atual: ${draftText}. Calculadora: ${calcText}. Use o atalho para substituir rapidamente o rascunho e, em seguida, fixe a base administrativa.`;
    }

    function applyCurrentQualifiersAsAdminDraft() {
      const amb = calcAmbiente(), ativ = calcAtividades(), corpo = calcCorpo();
      judicialControl.adminDraft.amb = amb.q;
      judicialControl.adminDraft.ativ = ativ.q;
      judicialControl.adminDraft.corpo = corpo.q;
      renderJudicialControl();
    }

    function fixAdminBaseFromDraft() {
      if (!getAdminDraftComplete()) {
        alert('Preencha os três qualificadores finais da base administrativa e os reconhecimentos do INSS em Funções do Corpo.');
        return;
      }
      judicialControl.adminBase = {
        amb: judicialControl.adminDraft.amb,
        ativ: judicialControl.adminDraft.ativ,
        corpo: judicialControl.adminDraft.corpo,
        corpoReconhecimentoInss: { ...judicialControl.adminDraft.corpoReconhecimentoInss }
      };
      judicialControl.med = createEmptyJudicialMed();

      savedINSS = {
        amb: judicialControl.adminBase.amb,
        ativ: judicialControl.adminBase.ativ,
        corpo: judicialControl.adminBase.corpo,
        result: tabelaConclusiva(judicialControl.adminBase.amb, judicialControl.adminBase.ativ, judicialControl.adminBase.corpo),
        impedimento: false,
        item: getItemNumber(judicialControl.adminBase.amb, judicialControl.adminBase.ativ, judicialControl.adminBase.corpo)
      };
      document.getElementById('compSection').classList.remove('hidden');
      document.getElementById('btnClearComp').classList.remove('hidden');
      updateComparison(calcAmbiente(), calcAtividades(), calcCorpo());
      clearJudicialTextArea();
      renderJudicialControl();
      document.getElementById('judicialControlSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function resetJudicialControl() {
      judicialControl.adminDraft = {
        amb: null,
        ativ: null,
        corpo: null,
        corpoReconhecimentoInss: createEmptyAdminCorpoRecognition()
      };
      judicialControl.adminBase = null;
      judicialControl.med = createEmptyJudicialMed();
      judicialControl.triage = { ready: false, status: 'pending', testeA: null, testeB: null, reason: '' };
      judicialControl.ui = { activeStep: 1, progressPct: 25, blockReason: '' };
      clearJudicialTextArea();
    }

    function clearJudicialMedicalAndTriage() {
      judicialControl.med = createEmptyJudicialMed();
      judicialControl.triage = { ready: false, status: 'pending', testeA: null, testeB: null, reason: '' };
      clearJudicialTextArea();
      renderJudicialControl();
      document.getElementById('copyFeedbackControle').textContent = judicialControl.adminBase
        ? 'Etapa médica e triagem reiniciadas. A base administrativa foi mantida.'
        : 'Controle judicial limpo.';
    }

    function renderJudicialControl() {
      syncQButtonGroup('jcAdminAmbButtons', judicialControl.adminDraft.amb);
      syncQButtonGroup('jcAdminAtivButtons', judicialControl.adminDraft.ativ);
      syncQButtonGroup('jcAdminCorpoButtons', judicialControl.adminDraft.corpo);
      syncSegmentedGroup('jcAdminEstruturasRecButtons', judicialControl.adminDraft.corpoReconhecimentoInss.estruturasReconhecidas == null ? null : (judicialControl.adminDraft.corpoReconhecimentoInss.estruturasReconhecidas ? 'sim' : 'nao'));
      syncSegmentedGroup('jcAdminProgRecButtons', judicialControl.adminDraft.corpoReconhecimentoInss.prognosticoReconhecido == null ? null : (judicialControl.adminDraft.corpoReconhecimentoInss.prognosticoReconhecido ? 'sim' : 'nao'));
      syncSegmentedGroup('jcCorpoKeepButtons', judicialControl.med.corpoKeepAdmin == null ? null : (judicialControl.med.corpoKeepAdmin ? 'sim' : 'nao'));
      syncQButtonGroup('jcCorpoManualButtons', judicialControl.med.corpoJudManual);
      JC_CORPO_RECLASS_DOMAINS.forEach(id => {
        syncQButtonGroup(`jcCorpo${id.toUpperCase()}Buttons`, judicialControl.med.corpoAdminDomains[id]);
      });
      syncQButtonGroup('jcAtivMedSimpleButtons', judicialControl.med.ativMedSimple);
      updateAdminAutofillShortcut();
      JC_ATIV_RECLASS_DOMAINS.forEach(id => {
        syncQButtonGroup(`jcAtiv${id.toUpperCase()}Buttons`, judicialControl.med.ativMedDomains[id]);
      });
      syncSegmentedGroup('jcImpedimentoButtons', judicialControl.med.impedimentoLP == null ? null : (judicialControl.med.impedimentoLP ? 'sim' : 'nao'));
      syncSegmentedGroup('jcHasAtivMedButtons', judicialControl.med.hasAtivMed == null ? null : (judicialControl.med.hasAtivMed ? 'sim' : 'nao'));
      syncSegmentedGroup('jcAtivModeButtons', judicialControl.med.ativMode);
      let corpoFlow = resolveCorpoJudFlow();
      judicialControl.med.corpoJud = corpoFlow.q;
      const reasonSelect = document.getElementById('jcCorpoReasonSelect');
      const reasonHint = document.getElementById('jcCorpoReasonHint');
      [...reasonSelect.options].forEach(opt => {
        if (!opt.value) return;
        opt.disabled = isCorpoReasonBlocked(opt.value);
      });
      if (judicialControl.med.corpoChangeReason && isCorpoReasonBlocked(judicialControl.med.corpoChangeReason)) {
        resetCorpoChangeDetails();
        corpoFlow = resolveCorpoJudFlow();
        judicialControl.med.corpoJud = corpoFlow.q;
      }
      reasonSelect.value = judicialControl.med.corpoChangeReason || '';
      if (!judicialControl.adminBase) {
        reasonHint.textContent = 'Fixe a base administrativa para habilitar os motivos.';
      } else if (judicialControl.med.corpoKeepAdmin === false) {
        reasonHint.textContent = judicialControl.med.corpoChangeReason
          ? (isCorpoReasonBlocked(judicialControl.med.corpoChangeReason)
            ? getCorpoReasonBlockedMessage(judicialControl.med.corpoChangeReason)
            : (JC_CORPO_REASON_LABELS[judicialControl.med.corpoChangeReason] || ''))
          : 'Selecione um motivo para definir o qualificador judicial de Funções do Corpo.';
      } else {
        reasonHint.textContent = '';
      }
      const showCorpoChange = judicialControl.med.corpoKeepAdmin === false;
      const showCorpoDomains = showCorpoChange && judicialControl.med.corpoChangeReason === 'dominio_max';
      const showCorpoManual = showCorpoChange && judicialControl.med.corpoChangeReason === 'rebaixamento';
      document.getElementById('jcCorpoChangeWrap').classList.toggle('hidden', !showCorpoChange);
      document.getElementById('jcCorpoDomainWrap').classList.toggle('hidden', !showCorpoDomains);
      document.getElementById('jcCorpoManualWrap').classList.toggle('hidden', !showCorpoManual);
      const reductionAlert = document.getElementById('jcCorpoReductionAlert');
      const reductionConfirm = document.getElementById('jcCorpoReductionConfirm');
      const hasReduction = showCorpoChange && corpoFlow.q != null && judicialControl.adminBase && corpoFlow.q < judicialControl.adminBase.corpo;
      reductionAlert.classList.toggle('hidden', !hasReduction);
      reductionConfirm.checked = !!judicialControl.med.corpoAlertReductionConfirmed;
      const corpoSummary = document.getElementById('jcCorpoResultSummary');
      if (!judicialControl.adminBase) {
        corpoSummary.textContent = 'Resultado de Funções do Corpo aguardando base administrativa.';
      } else if (judicialControl.med.corpoKeepAdmin == null) {
        corpoSummary.textContent = `Base administrativa em Funções: ${Q_LABELS[judicialControl.adminBase.corpo]} (${Q_NAMES[judicialControl.adminBase.corpo]}). Informe se deseja manter ou alterar.`;
      } else if (!corpoFlow.ready && corpoFlow.q == null) {
        corpoSummary.textContent = corpoFlow.reason;
      } else {
        const motivo = corpoFlow.mode === 'mantido' ? 'manutenção administrativa' : (JC_CORPO_REASON_LABELS[judicialControl.med.corpoChangeReason] || 'motivo não identificado');
        const extra = corpoFlow.mode === 'dominio_max' && corpoFlow.domainsText ? ` Domínios: ${corpoFlow.domainsText}.` : '';
        const pendencia = !corpoFlow.ready ? ` Pendência: ${corpoFlow.reason}` : '';
        corpoSummary.textContent = `Resultado judicial de Funções: ${Q_LABELS[corpoFlow.q]} (${Q_NAMES[corpoFlow.q]}), por ${motivo}.${extra}${pendencia}`;
      }
      const showAtivMed = judicialControl.med.hasAtivMed === true;
      const isSimple = showAtivMed && judicialControl.med.ativMode === 'simples';
      const isComplete = showAtivMed && judicialControl.med.ativMode === 'completa';
      document.getElementById('jcAtivMedWrap').classList.toggle('hidden', !showAtivMed);
      document.getElementById('jcAtivModeSimpleWrap').classList.toggle('hidden', !isSimple);
      document.getElementById('jcAtivModeCompleteWrap').classList.toggle('hidden', !isComplete);
      const justField = document.getElementById('jcAtivMedJustification');
      if (justField.value !== judicialControl.med.ativMedJustification) {
        justField.value = judicialControl.med.ativMedJustification;
      }
      const computed = updateAtivMedComputed();
      const summary = document.getElementById('jcAtivComputedSummary');
      if (!isComplete) {
        summary.textContent = 'Preencha d1–d9 para calcular o qualificador final de Atividades.';
      } else if (!computed) {
        const filled = JC_ATIV_RECLASS_DOMAINS.filter(id => judicialControl.med.ativMedDomains[id] != null).length;
        summary.textContent = `Preenchimento parcial: ${filled}/9 domínios. O qualificador final só será calculado após completar d1–d9.`;
      } else {
        summary.textContent = `Cálculo automático: (Σ × 2,777...) − 0,1 = ${computed.pct}% · Σ=${computed.sum} · Ativ_med final = ${Q_LABELS[computed.q]} (${Q_NAMES[computed.q]}).`;
      }
      renderAdminFixedSummary();

      const adminDone = !!judicialControl.adminBase;
      const adminDraftReady = getAdminDraftComplete();
      const adminDirty = isAdminDraftDirty();
      const adminStateClass = !adminDone ? 'pending' : (adminDirty ? 'pending' : 'done');
      const adminStateText = !adminDone ? (adminDraftReady ? 'Pronta para fixar' : 'Pendente') : (adminDirty ? 'Revalidar base' : 'Concluída');
      setStepState('jcAdminState', adminStateClass, adminStateText);

      if (!adminDone) {
        const blockReason = 'Etapa 2 bloqueada: primeiro fixe a base administrativa na etapa 1.';
        judicialControl.ui.blockReason = blockReason;
        setStepState('jcMedState', 'blocked', 'Bloqueada');
        setStepState('jcTriagemState', 'pending', 'Pendente');
        setStepState('jcTextoState', 'blocked', 'Aguardando triagem');
        setStatusBadge('pending', `${iconMarkup('alert', 'ui-icon sm')} Preencha as etapas 1 e 2 para liberar a conclusão probatória.`);
        document.getElementById('jcTrace').innerHTML = `<div class="jc-trace-line">Etapa 1: fixe a base administrativa do INSS para iniciar o controle judicial.</div>`;
        setWhyBlocked(blockReason);
        renderJudicialProgress();
        return;
      }

      const medDone = getMedComplete();
      setStepState('jcMedState', medDone ? 'done' : 'pending', medDone ? 'Concluída' : 'Pendente');
      const triage = computeJudicialTriage();
      judicialControl.triage = triage;

      if (!triage.ready) {
        judicialControl.ui.blockReason = triage.reason;
        setStepState('jcTriagemState', 'pending', 'Pendente');
        setStepState('jcTextoState', 'blocked', 'Aguardando triagem');
        setStatusBadge('pending', `${iconMarkup('alert', 'ui-icon sm')} ${triage.reason}`);
        document.getElementById('jcTrace').innerHTML = `<div class="jc-trace-line">${triage.reason}</div>`;
        setWhyBlocked(triage.reason);
        renderJudicialProgress();
        return;
      }

      judicialControl.ui.blockReason = '';
      setStepState('jcTriagemState', 'done', 'Concluída');
      setStepState('jcTextoState', 'done', 'Pronta');
      const b = judicialControl.adminBase;
      const m = judicialControl.med;
      const ativMedResolved = resolveAtivMed();
      const testALine = m.impedimentoLP
        ? `<div class="jc-trace-line"><strong>Teste A</strong>: tabela(Amb ${Q_LABELS[b.amb]}, Ativ ${Q_LABELS[b.ativ]}, Corpo_jud ${Q_LABELS[corpoFlow.q]}) = <strong>${triage.testeA ? 'Sim' : 'Não'}</strong>.</div>`
        : `<div class="jc-trace-line"><strong>Teste A</strong>: não aplicado porque não houve impedimento de longo prazo.</div>`;
      const testBLine = m.impedimentoLP && m.hasAtivMed && ativMedResolved != null
        ? `<div class="jc-trace-line"><strong>Teste B</strong>: tabela(Amb ${Q_LABELS[b.amb]}, Ativ_med ${Q_LABELS[ativMedResolved]}, Corpo_jud ${Q_LABELS[corpoFlow.q]}) = <strong>${triage.testeB ? 'Sim' : 'Não'}</strong>.</div>`
        : `<div class="jc-trace-line"><strong>Teste B</strong>: ${m.hasAtivMed ? 'aguardando definição válida do Ativ_med.' : 'não aplicado (sem elementos médicos para requalificar Atividades).'}</div>`;
      const routeLine = triage.status === 'necessaria'
        ? `<div class="jc-trace-line"><strong>Rotas de reversão pela avaliação social judicial</strong>: requalificação de <strong>Ambiente</strong> e/ou <strong>Atividades</strong>.</div>`
        : '';
      document.getElementById('jcTrace').innerHTML = [
        `<div class="jc-trace-line"><strong>Base administrativa fixada</strong>: Amb ${Q_LABELS[b.amb]} · Ativ ${Q_LABELS[b.ativ]} · Corpo ${Q_LABELS[b.corpo]}.</div>`,
        `<div class="jc-trace-line"><strong>Perícia médica judicial</strong>: impedimento de longo prazo = <strong>${m.impedimentoLP ? 'Sim' : 'Não'}</strong>.</div>`,
        getCorpoFlowTraceLine(corpoFlow),
        getAtivMedTraceLine(),
        testALine,
        testBLine,
        `<div class="jc-trace-line">${triage.reason}</div>`,
        routeLine
      ].filter(Boolean).join('');

      if (triage.status === 'dispensa') {
        setStatusBadge('dispensa', `${iconMarkup('check-circle', 'ui-icon sm')} <strong>Avaliação social judicial dispensável</strong>`);
      } else {
        setStatusBadge('necessaria', `${iconMarkup('alert', 'ui-icon sm')} <strong>Avaliação social judicial necessária</strong>`);
      }
      setWhyBlocked('');
      renderJudicialProgress();
    }

    function renderJudicialControlText() {
      const output = document.getElementById('textoControleJudicial');
      const triage = judicialControl.triage;
      if (!judicialControl.adminBase) {
        output.value = 'Fixe a base administrativa para habilitar a minuta do Controle Judicial.';
        return;
      }
      if (!triage.ready) {
        output.value = 'Complete a etapa da perícia médica judicial para concluir a triagem probatória.';
        return;
      }

      const b = judicialControl.adminBase;
      const m = judicialControl.med;
      const corpoFlow = resolveCorpoJudFlow();
      const ativMedResolved = resolveAtivMed();
      const testeAItem = m.impedimentoLP ? getItemNumber(b.amb, b.ativ, corpoFlow.q) : null;
      const testeBItem = m.impedimentoLP && m.hasAtivMed && ativMedResolved != null ? getItemNumber(b.amb, ativMedResolved, corpoFlow.q) : null;
      const qWord = q => ['nenhum', 'leve', 'moderado', 'grave', 'completo'][q];

      // Textos-base incorporados do arquivo modelos_textos_decisao_bpc.md (sem dependência externa)
      const baseIntro = `No controle judicial da prova técnica, parte-se da base administrativa já fixada (Ambiente ${qWord(b.amb)}, Atividades ${qWord(b.ativ)} e Funções ${qWord(b.corpo)}).`;
      const reconhecimento = `Na fase administrativa, registrou-se: estruturas do corpo mais graves = ${b.corpoReconhecimentoInss.estruturasReconhecidas ? 'sim' : 'não'}; prognóstico desfavorável = ${b.corpoReconhecimentoInss.prognosticoReconhecido ? 'sim' : 'não'}.`;

      const corpoPart = corpoFlow.mode === 'mantido'
        ? `manutenção de Funções do Corpo em grau ${qWord(corpoFlow.q)}`
        : `requalificação de Funções do Corpo para grau ${qWord(corpoFlow.q)}`;

      const ativPart = (m.hasAtivMed && ativMedResolved != null)
        ? ` e requalificação médica de Atividades e Participação para grau ${qWord(ativMedResolved)}`
        : ', mantendo-se inalterados os demais componentes';

      let paragrafo2 = '';
      if (triage.status === 'dispensa') {
        if (m.impedimentoLP === false) {
          paragrafo2 = 'Em perícia médica judicial, não se reconheceu impedimento de longo prazo, circunstância que, por si, afasta a utilidade de nova avaliação social para reversão do resultado nesta triagem.';
        } else if (triage.testeA) {
          paragrafo2 = `Em perícia médica judicial, reconheceu-se impedimento de longo prazo e ${corpoPart}${ativPart}. Aplicada essa reclassificação ao Teste A da Tabela Conclusiva (Anexo IV da Portaria Conjunta MDS/INSS nº 2/2015, item ${testeAItem}), o resultado passou a ser positivo, suficiente para o enquadramento sem necessidade de nova intervenção social no caso concreto.`;
        } else {
          paragrafo2 = `Em perícia médica judicial, reconheceu-se impedimento de longo prazo e ${corpoPart}${ativPart}. No Teste A (item ${testeAItem}), o resultado permaneceu negativo; contudo, no Teste B (item ${testeBItem}), houve resultado positivo, suficiente para o enquadramento sem necessidade de nova intervenção social no caso concreto.`;
        }
      } else {
        if (m.hasAtivMed && ativMedResolved != null) {
          paragrafo2 = `A perícia médica judicial reconheceu impedimento de longo prazo, mas a reclassificação médica de Funções do Corpo, isoladamente, não produziu resultado positivo na Tabela Conclusiva (Teste A, item ${testeAItem}). Também não houve resultado positivo em eventual requalificação médica de Atividades (Teste B, item ${testeBItem}), de modo que a prova médica, por si só, não foi suficiente para alterar o desfecho administrativo.`;
        } else {
          paragrafo2 = `A perícia médica judicial reconheceu impedimento de longo prazo, mas a reclassificação médica de Funções do Corpo, isoladamente, não produziu resultado positivo na Tabela Conclusiva (Teste A, item ${testeAItem}). Também não houve elementos médicos para requalificação de Atividades (Teste B), de modo que a prova médica, por si só, não foi suficiente para alterar o desfecho administrativo.`;
        }
      }

      const paragrafo3 = triage.status === 'dispensa'
        ? 'Nessas condições, a prova médica judicial mostrou-se bastante para definição do requisito biopsicossocial, de modo que a avaliação social judicial se revela dispensável nesta fase processual.'
        : 'Nesse contexto, permanece necessária a avaliação social judicial, com potencial de requalificação dos componentes de Ambiente e Atividades e Participação, a fim de permitir cognição probatória completa sobre o requisito biopsicossocial.';

      output.value = [baseIntro, reconhecimento, paragrafo2, paragrafo3].filter(Boolean).join('\n\n');
    }

    async function copyJudicialControlText() {
      const feedback = document.getElementById('copyFeedbackControle');
      const area = document.getElementById('textoControleJudicial');
      if (!area.value.trim()) {
        feedback.textContent = 'Gere o texto antes de copiar.';
        return;
      }
      try {
        await navigator.clipboard.writeText(area.value);
        feedback.textContent = 'Texto copiado para a área de transferência.';
      } catch (err) {
        area.focus();
        area.select();
        document.execCommand('copy');
        feedback.textContent = 'Não foi possível copiar automaticamente. Use Ctrl+C.';
      }
    }

    function generateAndCopyJudicialText() {
      renderJudicialControlText();
      copyJudicialControlText();
    }

    document.getElementById('btnSaveINSS').addEventListener('click', () => {
      applyCurrentQualifiersAsAdminDraft();
      fixAdminBaseFromDraft();
    });
    document.getElementById('btnUseCurrentAsBase').addEventListener('click', () => {
      applyCurrentQualifiersAsAdminDraft();
      document.getElementById('copyFeedbackControle').textContent = 'Rascunho preenchido com os qualificadores atuais da Calculadora. Revise e clique em "Fixar base administrativa".';
    });
    document.getElementById('btnFixarBaseAdmin').addEventListener('click', fixAdminBaseFromDraft);
    document.getElementById('btnClearComp').addEventListener('click', () => {
      savedINSS = null;
      document.getElementById('compSection').classList.add('hidden');
      document.getElementById('btnClearComp').classList.add('hidden');
      resetJudicialControl();
      renderJudicialControl();
    });

    function getAutoQualifiedChildDomains() {
      if (!crianca) return [];
      return [...DOM_ATIV_M, ...DOM_ATIV_S].filter(d => idadeMeses < d.cut);
    }

    function updateChildAutoSummary() {
      const summary = document.getElementById('childAutoSummary');
      if (!crianca) {
        summary.classList.add('hidden');
        summary.textContent = '';
        return;
      }
      const forced = getAutoQualifiedChildDomains();
      if (!forced.length) {
        summary.classList.add('hidden');
        summary.textContent = '';
        return;
      }
      summary.classList.remove('hidden');
      summary.textContent = `Autoqualificados por corte etário: ${forced.map(d => d.id.toUpperCase()).join(', ')}.`;
    }

    function renderStandardText(amb = calcAmbiente(), ativ = calcAtividades(), corpo = calcCorpo()) {
      const yes = !impedimento && tabelaConclusiva(amb.q, ativ.q, corpo.q);
      const reason = getDecisionReason(amb.q, ativ.q, corpo.q, yes);
      const forced = getAutoQualifiedChildDomains();
      const forcedText = forced.length
        ? `Nos domínios de Atividades e Participação abaixo do ponto de corte etário, foi aplicado automaticamente o qualificador 4 (dificuldade completa), conforme Portaria Conjunta MDS/INSS nº 2/2015: ${forced.map(d => `${d.id.toUpperCase()} (${d.name}, corte ${d.cut} meses)`).join('; ')}.`
        : '';
      const idadeTexto = crianca
        ? `Foi assinalada idade inferior a 16 anos, com idade informada de ${idadeValor} ${idadeUnidade} (${idadeMeses} meses).`
        : 'Não foi assinalada idade inferior a 16 anos, de modo que se considerou a faixa etária de 16 anos ou mais.';
      const qWord = q => ['nenhum', 'leve', 'moderado', 'grave', 'completo'][q];
      const contextoEtario = `${idadeTexto}${forcedText ? ` ${forcedText}` : ''}`;

      // Textos-base incorporados do arquivo modelos_textos_decisao_bpc.md (sem dependência externa)
      let paragrafo1 = '';
      let paragrafo2 = '';

      if (yes) {
        paragrafo1 = `À luz do art. 20, §§ 2º e 10, da Lei nº 8.742/1993, e dos critérios da Portaria Conjunta MDS/INSS nº 2/2015 (Anexo IV), examina-se o enquadramento da parte autora como pessoa com deficiência para fins de BPC. ${contextoEtario} No caso concreto, os qualificadores finais apurados foram: Fatores Ambientais em grau ${qWord(amb.q)}, Atividades e Participação em grau ${qWord(ativ.q)} e Funções do Corpo em grau ${qWord(corpo.q)}, com reconhecimento de impedimento de longo prazo. A combinação desses qualificadores, confrontada com a Tabela Conclusiva da Portaria, conduz a resultado positivo para reconhecimento do requisito biopsicossocial legal.`;
        paragrafo2 = 'Diante desse quadro técnico-normativo, reputo preenchido o requisito legal, motivo pelo qual a parte autora se enquadra no conceito de pessoa com deficiência para fins do benefício assistencial.';
      } else {
        if (impedimento) {
          paragrafo1 = `A controvérsia deve ser resolvida conforme o art. 20, §§ 2º e 10, da Lei nº 8.742/1993, em conjunto com a Portaria Conjunta MDS/INSS nº 2/2015 (Anexo IV). ${contextoEtario} Na avaliação produzida, os qualificadores finais resultaram em Fatores Ambientais ${qWord(amb.q)}, Atividades e Participação ${qWord(ativ.q)} e Funções do Corpo ${qWord(corpo.q)}. Consta, ainda, indicação técnica de possibilidade de resolução das alterações em prazo inferior a 2 (dois) anos, o que afasta o requisito de impedimento de longo prazo.`;
        } else {
          const reasonFinal = /[.!?]$/.test(reason) ? reason : `${reason}.`;
          paragrafo1 = `A controvérsia deve ser resolvida conforme o art. 20, §§ 2º e 10, da Lei nº 8.742/1993, em conjunto com a Portaria Conjunta MDS/INSS nº 2/2015 (Anexo IV). ${contextoEtario} Na avaliação produzida, os qualificadores finais resultaram em Fatores Ambientais ${qWord(amb.q)}, Atividades e Participação ${qWord(ativ.q)} e Funções do Corpo ${qWord(corpo.q)}, com reconhecimento de impedimento de longo prazo. Ainda que presente limitação funcional, a combinação normativa não supera o patamar mínimo exigido pela Tabela Conclusiva. ${reasonFinal}`;
        }
        paragrafo2 = 'Assim, à luz dos parâmetros legais e regulamentares aplicáveis, não se configura, neste ponto, o enquadramento da parte autora como pessoa com deficiência para fins de BPC/LOAS.';
      }

      document.getElementById('textoPadrao').value = [paragrafo1, paragrafo2].filter(Boolean).join('\n\n');
    }

    async function copyStandardText() {
      const feedback = document.getElementById('copyFeedback');
      const area = document.getElementById('textoPadrao');
      if (!area.value.trim()) {
        feedback.textContent = 'Gere o texto antes de copiar.';
        return;
      }
      try {
        await navigator.clipboard.writeText(area.value);
        feedback.textContent = 'Texto copiado para a área de transferência.';
      } catch (err) {
        area.focus();
        area.select();
        document.execCommand('copy');
        feedback.textContent = 'Texto copiado.';
      }
    }

    document.getElementById('btnGerarTexto').addEventListener('click', () => {
      document.getElementById('textoSection').classList.remove('hidden');
      renderStandardText();
      document.getElementById('copyFeedback').textContent = '';
    });
    document.getElementById('btnCopiarTexto').addEventListener('click', copyStandardText);
    document.getElementById('modeSwitcher').addEventListener('click', e => {
      const btn = e.target.closest('.mode-btn');
      if (!btn) return;
      setUIMode(btn.dataset.mode, { scrollToJudicial: btn.dataset.mode === 'controle' });
    });

    function bindQGroup(groupId, onPick) {
      document.getElementById(groupId).addEventListener('click', e => {
        const btn = e.target.closest('.jc-q-btn');
        if (!btn) return;
        onPick(+btn.dataset.value);
        renderJudicialControl();
      });
    }

    function bindSegmented(groupId, onPick) {
      document.getElementById(groupId).addEventListener('click', e => {
        const btn = e.target.closest('.jc-seg-btn');
        if (!btn) return;
        onPick(btn.dataset.value);
        renderJudicialControl();
      });
    }

    bindQGroup('jcAdminAmbButtons', value => { judicialControl.adminDraft.amb = value; clearJudicialTextArea(); });
    bindQGroup('jcAdminAtivButtons', value => { judicialControl.adminDraft.ativ = value; clearJudicialTextArea(); });
    bindQGroup('jcAdminCorpoButtons', value => { judicialControl.adminDraft.corpo = value; clearJudicialTextArea(); });
    bindSegmented('jcAdminEstruturasRecButtons', value => {
      judicialControl.adminDraft.corpoReconhecimentoInss.estruturasReconhecidas = value === 'sim';
      clearJudicialTextArea();
    });
    bindSegmented('jcAdminProgRecButtons', value => {
      judicialControl.adminDraft.corpoReconhecimentoInss.prognosticoReconhecido = value === 'sim';
      clearJudicialTextArea();
    });
    bindSegmented('jcCorpoKeepButtons', value => {
      if (!judicialControl.adminBase) return;
      judicialControl.med.corpoKeepAdmin = value === 'sim';
      resetCorpoChangeDetails();
      if (judicialControl.med.corpoKeepAdmin) {
        judicialControl.med.corpoJud = judicialControl.adminBase.corpo;
      }
      clearJudicialTextArea();
    });
    bindQGroup('jcCorpoManualButtons', value => {
      if (!judicialControl.adminBase || judicialControl.med.corpoKeepAdmin !== false || judicialControl.med.corpoChangeReason !== 'rebaixamento') return;
      judicialControl.med.corpoJudManual = value;
      judicialControl.med.corpoAlertReductionConfirmed = false;
      clearJudicialTextArea();
    });
    JC_CORPO_RECLASS_DOMAINS.forEach(id => {
      bindQGroup(`jcCorpo${id.toUpperCase()}Buttons`, value => {
        if (!judicialControl.adminBase || judicialControl.med.corpoKeepAdmin !== false || judicialControl.med.corpoChangeReason !== 'dominio_max') return;
        judicialControl.med.corpoAdminDomains[id] = value;
        judicialControl.med.corpoAlertReductionConfirmed = false;
        clearJudicialTextArea();
      });
    });
    document.getElementById('jcCorpoReasonSelect').addEventListener('change', e => {
      if (!judicialControl.adminBase || judicialControl.med.corpoKeepAdmin !== false) return;
      const nextReason = e.target.value || null;
      if (nextReason && isCorpoReasonBlocked(nextReason)) {
        e.target.value = '';
        return;
      }
      resetCorpoChangeDetails();
      judicialControl.med.corpoChangeReason = nextReason;
      clearJudicialTextArea();
      renderJudicialControl();
    });
    document.getElementById('jcCorpoReductionConfirm').addEventListener('change', e => {
      if (!judicialControl.adminBase) return;
      judicialControl.med.corpoAlertReductionConfirmed = e.target.checked;
      clearJudicialTextArea();
      renderJudicialControl();
    });
    bindQGroup('jcAtivMedSimpleButtons', value => {
      if (!judicialControl.adminBase) return;
      judicialControl.med.ativMedSimple = value;
      clearJudicialTextArea();
    });
    JC_ATIV_RECLASS_DOMAINS.forEach(id => {
      bindQGroup(`jcAtiv${id.toUpperCase()}Buttons`, value => {
        if (!judicialControl.adminBase) return;
        judicialControl.med.ativMedDomains[id] = value;
        judicialControl.med.ativMedComputed = computeAtivFromDomains(judicialControl.med.ativMedDomains);
        clearJudicialTextArea();
      });
    });
    bindSegmented('jcAtivModeButtons', value => {
      if (!judicialControl.adminBase || judicialControl.med.hasAtivMed !== true) return;
      judicialControl.med.ativMode = value;
      if (value === 'simples') {
        judicialControl.med.ativMedDomains = createEmptyAtivReclassDomains();
        judicialControl.med.ativMedComputed = null;
      } else if (value === 'completa') {
        judicialControl.med.ativMedSimple = null;
        judicialControl.med.ativMedJustification = '';
        judicialControl.med.ativMedComputed = computeAtivFromDomains(judicialControl.med.ativMedDomains);
      }
      clearJudicialTextArea();
    });
    bindSegmented('jcImpedimentoButtons', value => {
      if (!judicialControl.adminBase) return;
      judicialControl.med.impedimentoLP = value === 'sim';
      clearJudicialTextArea();
    });
    bindSegmented('jcHasAtivMedButtons', value => {
      if (!judicialControl.adminBase) return;
      judicialControl.med.hasAtivMed = value === 'sim';
      if (!judicialControl.med.hasAtivMed) resetAtivMedReclassFields();
      clearJudicialTextArea();
    });
    document.getElementById('jcAtivMedJustification').addEventListener('input', e => {
      if (!judicialControl.adminBase || judicialControl.med.hasAtivMed !== true) return;
      judicialControl.med.ativMedJustification = e.target.value;
      clearJudicialTextArea();
      renderJudicialControl();
    });

    document.getElementById('btnGerarControleTexto').addEventListener('click', () => {
      renderJudicialControlText();
      document.getElementById('copyFeedbackControle').textContent = '';
    });
    document.getElementById('btnGerarCopiarControleTexto').addEventListener('click', generateAndCopyJudicialText);
    document.getElementById('btnCopiarControleTexto').addEventListener('click', copyJudicialControlText);
    document.getElementById('btnLimparControleJudicial').addEventListener('click', clearJudicialMedicalAndTriage);

    // ============ INIT ============
    buildDomainRows(document.getElementById('domAmb'), DOM_AMB);
    buildDomainRows(document.getElementById('domCorpo'), DOM_CORPO);
    buildDomainRows(document.getElementById('domAtivM'), DOM_ATIV_M);
    buildDomainRows(document.getElementById('domAtivS'), DOM_ATIV_S);
    syncChildModeByControls();
    applyChildRules();
    resetJudicialControl();
    renderJudicialControl();
    setUIMode('controle', { preserveAccordionState: false });
    buildTabelaGrid();
    update();
  </script>
</body>

</html>
